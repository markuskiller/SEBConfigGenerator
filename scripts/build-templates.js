#!/usr/bin/env node
/**
 * Build Script for SEB Config Generator Templates
 * 
 * This script generates JavaScript module files from JSON source templates.
 * 
 * Directory Structure:
 * - templates/source/services/*.json  â†’ Individual service preset definitions
 * - templates/source/subjects/*.json  â†’ Subject configurations
 * - templates/generated/              â†’ Generated .js files (imported by app.js)
 * 
 * Usage:
 *   node scripts/build-templates.js
 * 
 * This script is run:
 * - Manually during development
 * - Automatically via npm run build (if configured)
 * - Before deployment to generate production files
 */

const fs = require('fs');
const path = require('path');

// Paths
const ROOT_DIR = path.join(__dirname, '..');
const SOURCE_DIR = path.join(ROOT_DIR, 'templates', 'source');
const GENERATED_DIR = path.join(ROOT_DIR, 'templates', 'generated');

// Ensure generated directory exists
if (!fs.existsSync(GENERATED_DIR)) {
    fs.mkdirSync(GENERATED_DIR, { recursive: true });
}

console.log('ğŸ”¨ Building SEB Config Generator Templates...\n');

// ============================================================================
// Load all service presets from JSON files
// ============================================================================
function loadServicePresets() {
    const servicesDir = path.join(SOURCE_DIR, 'services');
    const serviceFiles = fs.readdirSync(servicesDir).filter(f => f.endsWith('.json'));
    
    const presets = {};
    const presetGroups = {
        noLogin: [],
        withLogin: [],
        allowedTools: {}
    };
    
    console.log('ğŸ“¦ Loading service presets:');
    
    for (const file of serviceFiles) {
        const filePath = path.join(servicesDir, file);
        const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
        
        // Build PRESETS object (id â†’ config without metadata)
        const { id, name, description, category, language, ...config } = data;
        presets[id] = config;
        
        // Categorize for PRESET_GROUPS
        if (category === 'noLogin') {
            presetGroups.noLogin.push(id);
        } else if (category === 'withLogin') {
            presetGroups.withLogin.push(id);
        } else if (category === 'allowedTools') {
            if (!presetGroups.allowedTools[language]) {
                presetGroups.allowedTools[language] = [];
            }
            presetGroups.allowedTools[language].push(id);
        }
        
        console.log(`  âœ“ ${id.padEnd(15)} - ${name}`);
    }
    
    console.log(`\n  Total: ${Object.keys(presets).length} service presets\n`);
    
    return { presets, presetGroups };
}

// ============================================================================
// Load all subject configurations from JSON files
// ============================================================================
function loadSubjects() {
    const subjectsDir = path.join(SOURCE_DIR, 'subjects');
    const subjectFiles = fs.readdirSync(subjectsDir).filter(f => f.endsWith('.json'));
    
    const subjects = {};
    
    console.log('ğŸ“š Loading subject configurations:');
    
    for (const file of subjectFiles) {
        const filePath = path.join(subjectsDir, file);
        const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
        subjects[data.id] = {
            toolPresets: data.toolPresets
        };
        console.log(`  âœ“ ${data.id.padEnd(15)} - ${data.name}`);
    }
    
    console.log(`\n  Total: ${Object.keys(subjects).length} subjects\n`);
    
    return subjects;
}

// ============================================================================
// Generate JavaScript module files
// ============================================================================
function generatePresetsModule(presets) {
    const output = `// Generated file - DO NOT EDIT MANUALLY
// Source: templates/source/services/*.json
// Generated: ${new Date().toISOString()}
//
// This file is automatically generated by scripts/build-templates.js
// To modify presets, edit the JSON files in templates/source/services/
// and run: node scripts/build-templates.js

const PRESETS = ${JSON.stringify(presets, null, 4)};

export { PRESETS };
`;
    
    const outputPath = path.join(GENERATED_DIR, 'presets.js');
    fs.writeFileSync(outputPath, output, 'utf8');
    console.log(`âœ… Generated: ${path.relative(ROOT_DIR, outputPath)}`);
}

function generateSubjectsModule(subjects) {
    const output = `// Generated file - DO NOT EDIT MANUALLY
// Source: templates/source/subjects/*.json
// Generated: ${new Date().toISOString()}
//
// This file is automatically generated by scripts/build-templates.js
// To modify subjects, edit the JSON files in templates/source/subjects/
// and run: node scripts/build-templates.js

const SUBJECTS = ${JSON.stringify(subjects, null, 4)};

export { SUBJECTS };
`;
    
    const outputPath = path.join(GENERATED_DIR, 'subjects.js');
    fs.writeFileSync(outputPath, output, 'utf8');
    console.log(`âœ… Generated: ${path.relative(ROOT_DIR, outputPath)}`);
}

function generatePresetGroupsModule(presetGroups) {
    const output = `// Generated file - DO NOT EDIT MANUALLY
// Source: templates/source/services/*.json (derived from categories)
// Generated: ${new Date().toISOString()}
//
// This file is automatically generated by scripts/build-templates.js

const PRESET_GROUPS = ${JSON.stringify(presetGroups, null, 4)};

export { PRESET_GROUPS };
`;
    
    const outputPath = path.join(GENERATED_DIR, 'preset-groups.js');
    fs.writeFileSync(outputPath, output, 'utf8');
    console.log(`âœ… Generated: ${path.relative(ROOT_DIR, outputPath)}`);
}

// ============================================================================
// Generate README for contributors
// ============================================================================
function generateReadme() {
    const readme = `# Service & Subject Templates

This directory contains the template system for SEB Config Generator presets.

## ğŸ“ Directory Structure

\`\`\`
templates/
â”œâ”€â”€ source/                   # Source JSON files (edit these!)
â”‚   â”œâ”€â”€ services/             # Service/tool presets
â”‚   â”‚   â”œâ”€â”€ onenote.json      # OneNote preset
â”‚   â”‚   â”œâ”€â”€ whiteboard.json   # Whiteboard.fi preset
â”‚   â”‚   â”œâ”€â”€ duden.json        # Duden dictionary
â”‚   â”‚   â””â”€â”€ ...               # More services
â”‚   â””â”€â”€ subjects/             # Subject configurations
â”‚       â”œâ”€â”€ german.json       # German language tools
â”‚       â”œâ”€â”€ english.json      # English language tools
â”‚       â””â”€â”€ french.json       # French language tools
â””â”€â”€ generated/                # Generated JS files (auto-generated)
    â”œâ”€â”€ presets.js            # All service presets
    â”œâ”€â”€ subjects.js           # All subject configurations
    â””â”€â”€ preset-groups.js      # Categorized preset groups
\`\`\`

## ğŸ¯ How to Add a New Service

### 1. Create a new JSON file in \`source/services/\`

Example: \`templates/source/services/mynewservice.json\`

\`\`\`json
{
  "id": "mynewservice",
  "name": "My New Service",
  "description": "Description for UI",
  "category": "noLogin",
  "startUrl": "https://example.com",
  "domains": [
    "example.com",
    "*.example.com"
  ]
}
\`\`\`

### 2. Available Categories

- \`noLogin\` - Services without authentication (e.g., Kahoot, Whiteboard.fi)
- \`withLogin\` - Services requiring login (e.g., OneNote, Word Online)
- \`allowedTools\` - Subject-specific tools (dictionaries, calculators)

For \`allowedTools\`, add \`"language": "german"\` (or english, french, etc.)

### 3. Run the build script

\`\`\`bash
node scripts/build-templates.js
\`\`\`

### 4. Test your changes

The generated files are automatically imported by \`js/app.js\`.

## ğŸŒ How to Add a New Subject

### 1. Create a new JSON file in \`source/subjects/\`

Example: \`templates/source/subjects/spanish.json\`

\`\`\`json
{
  "id": "spanish",
  "name": "EspaÃ±ol",
  "toolPresets": ["rae", "wordreference"]
}
\`\`\`

### 2. Add the corresponding tool services

Create \`source/services/rae.json\` and \`source/services/wordreference.json\`

### 3. Run the build script

\`\`\`bash
node scripts/build-templates.js
\`\`\`

## ğŸ”„ When to Rebuild

Run \`node scripts/build-templates.js\` whenever you:
- Add a new service JSON file
- Modify an existing service JSON file
- Add a new subject JSON file
- Change subject tool associations

## ğŸ¤ Contributing

1. Fork the repository
2. Add your service/subject JSON files
3. Run the build script
4. Test the changes locally
5. Submit a pull request

**Note:** Only modify files in \`source/\` directory. Never edit files in \`generated/\` directly!

## ğŸ“ JSON Schema Reference

### Service Preset Schema

\`\`\`typescript
{
  id: string;              // Unique identifier (lowercase, no spaces)
  name: string;            // Display name for UI
  description: string;     // Brief description
  category: "noLogin" | "withLogin" | "allowedTools";
  language?: string;       // Required for allowedTools category
  startUrl: string;        // Starting URL
  domains: string[];       // Allowed domains (wildcards supported)
  blockedDomains?: string[]; // Optional: Explicitly blocked domains
}
\`\`\`

### Subject Schema

\`\`\`typescript
{
  id: string;              // Unique identifier (lowercase)
  name: string;            // Display name for UI
  toolPresets: string[];   // Array of tool preset IDs
}
\`\`\`

---

**Generated:** ${new Date().toISOString()}  
**Script:** \`scripts/build-templates.js\`
`;
    
    const readmePath = path.join(ROOT_DIR, 'templates', 'README.md');
    fs.writeFileSync(readmePath, readme, 'utf8');
    console.log(`âœ… Generated: ${path.relative(ROOT_DIR, readmePath)}`);
}

// ============================================================================
// Main execution
// ============================================================================
try {
    const { presets, presetGroups } = loadServicePresets();
    const subjects = loadSubjects();
    
    console.log('ğŸ“ Generating JavaScript modules:\n');
    generatePresetsModule(presets);
    generateSubjectsModule(subjects);
    generatePresetGroupsModule(presetGroups);
    generateReadme();
    
    console.log('\nâœ¨ Build completed successfully!\n');
    console.log('ğŸ“Œ Next steps:');
    console.log('   1. Review generated files in templates/generated/');
    console.log('   2. Import in js/app.js (if not already done)');
    console.log('   3. Test the application');
    console.log('   4. Commit both source and generated files\n');
    
} catch (error) {
    console.error('\nâŒ Build failed:', error.message);
    console.error(error.stack);
    process.exit(1);
}
