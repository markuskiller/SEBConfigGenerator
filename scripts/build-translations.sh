#!/usr/bin/env bash

# ============================================================================
# Build Translations
# ============================================================================
# This script generates translations.js from JSON translation files
#
# Usage: bash scripts/build-translations.sh
# ============================================================================

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Determine project root (parent of scripts directory)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

TRANSLATIONS_DIR="$PROJECT_ROOT/translations"
GENERATED_DIR="$PROJECT_ROOT/templates/generated"

echo -e "${BLUE}üåç Building Translations...${NC}\n"
echo "üìÇ Project root: $PROJECT_ROOT"
echo ""

# ============================================================================
# Generate translations.js from JSON files
# ============================================================================
echo -e "${GREEN}üî§ Generating translations.js from JSON files...${NC}"

# Start building the JavaScript object
TRANSLATIONS_JS="const TRANSLATIONS = {"

first_lang=true

# Process each JSON file in translations directory
for json_file in "$TRANSLATIONS_DIR"/*.json; do
    [ -f "$json_file" ] || continue
    
    # Get language code from filename (e.g., de.json -> de)
    lang_code=$(basename "$json_file" .json)
    
    echo "  - Processing $lang_code.json"
    
    # Add comma separator for subsequent languages
    if [ "$first_lang" = true ]; then
        first_lang=false
    else
        TRANSLATIONS_JS="$TRANSLATIONS_JS,"
    fi
    
    # Add language code and JSON content
    TRANSLATIONS_JS="$TRANSLATIONS_JS\"$lang_code\": $(cat "$json_file")"
done

TRANSLATIONS_JS="$TRANSLATIONS_JS};"

# Build a proper JSON object using jq (avoids shell escaping issues)
# Create a temporary file to hold the combined JSON
TEMP_JSON=$(mktemp)

# Use jq to properly combine JSON files
jq -n \
    --slurpfile de "$TRANSLATIONS_DIR/de.json" \
    --slurpfile en "$TRANSLATIONS_DIR/en.json" \
    '{de: $de[0], en: $en[0]}' > "$TEMP_JSON"

# Format and write the file
cat > "$GENERATED_DIR/translations.js" << EOF
// Generated file - DO NOT EDIT MANUALLY
// Source: translations/*.json
// Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
//
// This file is automatically generated by scripts/build-translations.sh
// To modify translations, edit the JSON files in translations/
// and run: bash scripts/build-translations.sh
// This file is included directly in index.html before app.js

const TRANSLATIONS = $(cat "$TEMP_JSON" | jq .);
EOF

# Clean up temp file
rm -f "$TEMP_JSON"

echo -e "\n${GREEN}‚úÖ Generated: templates/generated/translations.js${NC}\n"

# ============================================================================
# Validation
# ============================================================================
echo -e "${GREEN}üîç Validating translations...${NC}"

# Get list of all language codes
languages=()
for json_file in "$TRANSLATIONS_DIR"/*.json; do
    [ -f "$json_file" ] || continue
    lang_code=$(basename "$json_file" .json)
    languages+=("$lang_code")
done

echo "  Languages found: ${languages[*]}"

# Get all keys from the first language (reference)
reference_lang="${languages[0]}"
reference_keys=$(jq -r 'keys[]' "$TRANSLATIONS_DIR/$reference_lang.json" | sort)
reference_count=$(echo "$reference_keys" | wc -l | tr -d ' ')

echo "  Reference language: $reference_lang ($reference_count keys)"

# Check each language for missing or extra keys
all_valid=true

for lang in "${languages[@]}"; do
    if [ "$lang" = "$reference_lang" ]; then
        continue
    fi
    
    lang_keys=$(jq -r 'keys[]' "$TRANSLATIONS_DIR/$lang.json" | sort)
    lang_count=$(echo "$lang_keys" | wc -l | tr -d ' ')
    
    # Use temporary files instead of process substitution (for sh compatibility)
    TEMP_REF=$(mktemp)
    TEMP_LANG=$(mktemp)
    echo "$reference_keys" > "$TEMP_REF"
    echo "$lang_keys" > "$TEMP_LANG"
    
    # Find missing keys
    missing=$(comm -23 "$TEMP_REF" "$TEMP_LANG")
    
    # Find extra keys
    extra=$(comm -13 "$TEMP_REF" "$TEMP_LANG")
    
    # Clean up temp files
    rm -f "$TEMP_REF" "$TEMP_LANG"
    
    if [ -n "$missing" ]; then
        echo "  ‚ö†Ô∏è  $lang.json is missing keys:"
        echo "$missing" | sed 's/^/      - /'
        all_valid=false
    fi
    
    if [ -n "$extra" ]; then
        echo "  ‚ö†Ô∏è  $lang.json has extra keys:"
        echo "$extra" | sed 's/^/      - /'
        all_valid=false
    fi
    
    if [ -z "$missing" ] && [ -z "$extra" ]; then
        echo "  ‚úì $lang.json ($lang_count keys) - complete"
    fi
done

echo ""

if [ "$all_valid" = true ]; then
    echo -e "${GREEN}‚ú® All translations are valid!${NC}\n"
else
    echo -e "${BLUE}üí° Fix missing/extra keys in translation files${NC}\n"
fi

# ============================================================================
# Summary
# ============================================================================
echo -e "${GREEN}üéâ Build completed successfully!${NC}\n"

echo "üìä Generated files:"
ls -lh "$GENERATED_DIR/translations.js" | awk '{printf "   %s (%s)\n", $9, $5}'

echo ""
echo "üí° Don't forget to commit the updated files:"
echo "   git add translations/*.json templates/generated/translations.js"
echo "   git commit -m 'Update translations'"
