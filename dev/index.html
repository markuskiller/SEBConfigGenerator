<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>SEB Konfigurations-Generator</title>
    <style>
        /* ============================================================================
           COLOR PALETTE - Soft Navy Blue Theme (#2c3e5a)
           ============================================================================
           Primary: #2c3e5a (Navy Soft), #3d5170 (Navy Medium), #4a6fa5 (Blue Medium)
           Accent: #5b9bd5 (Sky Blue), #7eb8e6 (Light Blue), #2dce89 (Success Green)
           Backgrounds: #e8edf5 (Soft Blue-Gray), #f5f7fb (Light Blue-Gray), #dfe6f0 (Blue-Tint)
           Text: #2c3e5a (Navy Soft), #525f7f (Gray Medium), #6c7a89 (Gray Light)
           Version/Footer: #8898aa (Medium Gray on dark background)
           ============================================================================ */
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            background: linear-gradient(135deg, #3d5170 0%, #4a6fa5 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        
        /* Dev Version Banner */
        .dev-banner {
            background: rgba(255, 255, 0, 0.748);
            border-bottom: 2px solid rgba(255, 215, 0, 1);
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #000000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin-bottom: 2px;
        }
        
        .dev-banner-left {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 0.95em;
            color: #000000;
        }
        
        .dev-banner-right {
            display: flex;
            gap: 20px;
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 0.9em;
            color: #000000;
        }
        
        .dev-banner-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dev-banner-label {
            opacity: 0.7;
            font-size: 0.95em;
        }
        
        .dev-banner-value {
            font-weight: 600;
            background: rgba(0, 0, 0, 0.08);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: #e8edf5; 
            border-radius: 12px; 
            box-shadow: 0 20px 60px rgba(44, 62, 90, 0.3); 
            overflow: hidden; 
        }
        
        .header { 
            background: linear-gradient(135deg, #2c3e5a 0%, #3d5170 100%); 
            color: #f5f7fb; 
            padding: 40px 30px; 
            text-align: center; 
            position: relative; 
        }
        
        .language-toggle { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            display: flex; 
            gap: 10px; 
        }
        
        .lang-btn { 
            background: rgba(245, 247, 251, 0.15); 
            border: 2px solid rgba(245, 247, 251, 0.4); 
            color: #f5f7fb; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
        }
        
        .lang-btn:hover { 
            background: rgba(245, 247, 251, 0.25); 
            border-color: rgba(245, 247, 251, 0.6); 
        }
        
        .lang-btn.active { 
            background: #5b9bd5; 
            color: #f5f7fb; 
            border-color: #5b9bd5; 
        }
        
        .header h1 { 
            font-size: 2em; 
            margin-bottom: 10px; 
        }
        
        .header p { 
            opacity: 0.9; 
            font-size: 1.1em; 
        }
        
        .content { 
            padding: 40px 30px; 
        }
        
        .section { 
            margin-bottom: 40px; 
        }
        
        .section h2 { 
            color: #2c3e5a; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #5b9bd5; 
        }
        
        .form-group { 
            margin-bottom: 25px; 
        }
        
        label { 
            display: block; 
            font-weight: 600; 
            color: #2c3e5a; 
            margin-bottom: 8px; 
        }
        
        input[type="text"], 
        input[type="url"], 
        textarea, 
        select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #dfe6f0; 
            border-radius: 6px; 
            font-size: 14px; 
            background: #f5f7fb; 
            color: #2c3e5a; 
            transition: all 0.3s; 
        }
        
        input:focus, 
        textarea:focus, 
        select:focus { 
            outline: none; 
            border-color: #5b9bd5; 
            background: #ffffff; 
            box-shadow: 0 0 0 3px rgba(91, 155, 213, 0.15); 
        }
        
        textarea { 
            min-height: 150px; 
            font-family: 'Courier New', monospace; 
            resize: vertical; 
        }
        
        .preset-buttons { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .preset-btn { 
            padding: 15px; 
            border: 2px solid #dfe6f0; 
            border-radius: 8px; 
            background: #f5f7fb; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-align: left; 
        }
        
        .preset-btn:hover { 
            border-color: #5b9bd5; 
            background: #ffffff; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.25); 
        }
        
        .preset-btn.active { 
            border-color: #5b9bd5; 
            background: linear-gradient(135deg, #d4e6f7 0%, #e8f2fa 100%); 
            box-shadow: 0 0 0 3px rgba(91, 155, 213, 0.2); 
        }
        
        .preset-btn h3 { 
            color: #2c3e5a; 
            margin-bottom: 5px; 
            font-size: 1.1em; 
        }
        
        .preset-btn p { 
            color: #6c7a89; 
            font-size: 0.9em; 
        }
        
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .checkbox-group input[type="checkbox"] { 
            width: 20px; 
            height: 20px; 
            margin-right: 10px; 
            cursor: pointer; 
            accent-color: #5b9bd5; 
        }
        
        .security-level { 
            display: flex; 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .security-option { 
            flex: 1; 
            padding: 20px; 
            border: 2px solid #dfe6f0; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s; 
            background: #f5f7fb; 
        }
        
        .security-option:hover { 
            border-color: #5b9bd5; 
            background: #ffffff; 
        }
        
        .security-option.active { 
            border-color: #5b9bd5; 
            background: linear-gradient(135deg, #d4e6f7 0%, #e8f2fa 100%); 
            box-shadow: 0 0 0 3px rgba(91, 155, 213, 0.2); 
        }
        
        .security-option h4 { 
            color: #2c3e5a; 
            margin-bottom: 8px; 
        }
        
        .security-option p { 
            color: #6c7a89; 
            font-size: 0.9em; 
        }
        
        .btn { 
            padding: 15px 30px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #4a6fa5 0%, #5b9bd5 100%); 
            color: #f5f7fb; 
            box-shadow: 0 4px 12px rgba(74, 111, 165, 0.3); 
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(74, 111, 165, 0.4); 
        }
        
        .btn-secondary { 
            background: #f5f7fb; 
            color: #2c3e5a; 
            border: 2px solid #dfe6f0; 
        }
        
        .btn-secondary:hover { 
            background: #ffffff; 
            border-color: #5b9bd5; 
        }
        
        .actions { 
            display: flex; 
            gap: 15px; 
            margin-top: 30px; 
            flex-wrap: wrap; 
        }
        
        .info-box { 
            background: linear-gradient(135deg, #d4e6f7 0%, #e8f2fa 100%); 
            border-left: 4px solid #5b9bd5; 
            padding: 15px; 
            margin-top: 20px; 
            border-radius: 4px; 
        }
        
        .info-box h4 { 
            color: #2c3e5a; 
            margin-bottom: 8px; 
        }
        
        .info-box p { 
            color: #3d5170; 
            font-size: 0.95em; 
            line-height: 1.6; 
        }
        
        .preview { 
            background: #f5f7fb; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 20px; 
            border: 2px solid #dfe6f0; 
        }
        
        .preview h3 { 
            color: #2c3e5a; 
            margin-bottom: 15px; 
        }
        
        .domain-list { 
            font-family: 'Courier New', monospace; 
            font-size: 0.9em; 
            color: #3d5170; 
            line-height: 1.8; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        
        .domain-item { 
            padding: 5px 0; 
            border-bottom: 1px solid #dfe6f0; 
        }
        
        .badge { 
            display: inline-block; 
            padding: 4px 10px; 
            background: linear-gradient(135deg, #4a6fa5 0%, #5b9bd5 100%); 
            color: #f5f7fb; 
            border-radius: 12px; 
            font-size: 0.85em; 
            margin-left: 10px; 
        }
        
        .doc-link { 
            transition: all 0.3s; 
        }
        
        .doc-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.4); 
            opacity: 1 !important; 
        }
        
        /* Advanced Section Collapsible */
        .advanced-section {
            margin-top: 30px;
            margin-bottom: 40px;
            border: 2px solid #5b9bd5;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f7fb;
        }
        
        .advanced-header {
            background: linear-gradient(135deg, #4a6fa5 0%, #5b9bd5 100%);
            color: #f5f7fb;
            padding: 20px 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
            user-select: none;
        }
        
        .advanced-header:hover {
            background: linear-gradient(135deg, #3d5170 0%, #4a6fa5 100%);
        }
        
        .advanced-header h2 {
            margin: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #f5f7fb;
            border-bottom: none;
        }
        
        .advanced-toggle {
            font-size: 1.5em;
            transition: transform 0.3s;
        }
        
        .advanced-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background: #e8edf5;
        }
        
        .advanced-content.expanded {
            max-height: 10000px;
            transition: max-height 0.6s ease-in;
        }
        
        .advanced-content-inner {
            padding: 30px;
        }
        
        @media (max-width: 768px) { 
            .security-level, 
            .actions { 
                flex-direction: column; 
            } 
            .language-toggle { 
                position: static; 
                margin-bottom: 20px; 
                justify-content: center; 
            } 
        }
    </style>
</head>
<body>
    <!-- Dev Version Banner -->
    <div class="dev-banner">
        <div class="dev-banner-left">üöß Latest Dev Version</div>
        <div class="dev-banner-right">
            <div class="dev-banner-item">
                <span class="dev-banner-label">Version:</span>
                <span class="dev-banner-value" id="devVersion">‚Äî</span>
            </div>
            <div class="dev-banner-item">
                <span class="dev-banner-label">Commit:</span>
                <span class="dev-banner-value" id="devCommit">‚Äî</span>
            </div>
            <div class="dev-banner-item">
                <span class="dev-banner-label">Build:</span>
                <span class="dev-banner-value" id="devBuild">‚Äî</span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="language-toggle">
                <button class="lang-btn active" data-lang="de">Deutsch</button>
                <button class="lang-btn" data-lang="en">English</button>
            </div>
            <h1>üõ°Ô∏è <span data-i18n="title">SEB Konfigurations-Generator</span></h1>
            <p data-i18n="subtitle">Erstellen Sie Safe Exam Browser Konfigurationen f√ºr Fokus-Modus im Unterricht</p>
            <p style="margin-top: 15px;">
                <a href="#" id="mainDocLink" class="doc-link" target="_blank" rel="noopener noreferrer" style="color: #f5f7fb; text-decoration: none; opacity: 0.95; font-weight: 600; border: 2px solid rgba(245, 247, 251, 0.5); padding: 8px 16px; border-radius: 6px; display: inline-block;">
                    üìö <span data-i18n="mainDocLink">Vollst√§ndige Anleitung</span>
                </a>
            </p>
            <div style="margin-top: 20px; padding: 12px 20px; background: rgba(45, 206, 137, 0.15); border: 2px solid rgba(45, 206, 137, 0.4); border-radius: 8px; color: #f5f7fb; font-size: 0.9em; line-height: 1.6;">
                <strong>üîí <span data-i18n="privacyTitle">Datenschutz:</span></strong> <span data-i18n="privacyText">Alle Daten werden ausschlie√ülich lokal in Ihrem Browser verarbeitet. Es werden keine Konfigurationsdaten oder Eingaben an unseren Server gesendet oder gespeichert. Nur Ihre Sprachpr√§ferenz wird lokal im Browser gespeichert.</span>
            </div>
            <p style="margin-top: 15px; text-align: center;">
                <a href="https://github.com/markuskiller/SEBConfigGenerator/issues/new" target="_blank" rel="noopener noreferrer" style="color: #f5f7fb; text-decoration: none; opacity: 0.9; font-size: 0.9em; border: 1px solid rgba(245, 247, 251, 0.3); padding: 6px 14px; border-radius: 6px; display: inline-block;">
                    üí° <span data-i18n="suggestService">Dienst oder Hilfsmittel vorschlagen</span>
                </a>
            </p>
        </div>
        <div class="content">
            <div class="section">
                <h2><span data-i18n="step1">1. Dienst ausw√§hlen</span></h2>
                <div class="preset-buttons" id="presetButtons"></div>
            </div>
            <div class="section">
                <h2><span data-i18n="step2">2. Konfigurationseinstellungen</span></h2>
                <div class="form-group">
                    <label data-i18n="startUrl">Start-URL</label>
                    <input type="url" id="startUrl" placeholder="https://www.onenote.com/notebooks">
                </div>
                <div class="form-group">
                    <label data-i18n="configName">Konfigurationsname</label>
                    <input type="text" id="configName" placeholder="Meine_Schule_OneNote">
                </div>
                
                <!-- SharePoint Link Configuration (shown only for OneNote/Word) -->
                <div class="form-group" id="sharepointLinkGroup" style="display: none;">
                    <label data-i18n="sharepointLinkLabel">SharePoint-Link (Optional - f√ºr erweiterte Filterung)</label>
                    <input type="url" id="sharepointLink" data-i18n-placeholder="sharepointLinkPlaceholder" placeholder="https://schule.sharepoint.com/sites/...">
                    <div id="sharepointHelp" style="margin-top: 8px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.9em; color: #856404; display: none;">
                        <!-- Help text will be inserted here dynamically -->
                    </div>
                    <div id="sharepointOptions" style="margin-top: 15px; display: none;">
                        <!-- SharePoint options will be rendered here dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label data-i18n="additionalOptions">Zus√§tzliche Optionen</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowDownloads" checked>
                        <label for="allowDownloads" data-i18n="allowDownloads">Datei-Downloads erlauben</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowSpellCheck" checked>
                        <label for="allowSpellCheck" data-i18n="allowSpellCheck">Rechtschreibpr√ºfung erlauben</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showReloadButton" checked>
                        <label for="showReloadButton" data-i18n="showReloadButton">Neu-Laden-Button anzeigen</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="allowBackForward" checked>
                        <label for="allowBackForward" data-i18n="allowBackForward">Vor/Zur√ºck-Navigation erlauben</label>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2><span data-i18n="step3">3. Benutzerdefinierte Domains (Optional)</span></h2>
                <div class="form-group">
                    <label data-i18n="customDomainsLabel">Zus√§tzliche erlaubte Domains hinzuf√ºgen (eine pro Zeile)</label>
                    <textarea id="customDomains" data-i18n-placeholder="customDomainsPlaceholder" placeholder="beispiel.de&#10;*.schule-domain.de"></textarea>
                </div>
                <div class="form-group">
                    <label data-i18n="blockedDomainsLabel">Zus√§tzlich zu sperrende Domains (Optional, eine pro Zeile)</label>
                    <textarea id="blockedDomains" data-i18n-placeholder="blockedDomainsPlaceholder" placeholder="facebook.com&#10;instagram.com&#10;tiktok.com"></textarea>
                </div>
                <div class="info-box">
                    <h4 data-i18n="proTipTitle">üí° Profi-Tipp</h4>
                    <p data-i18n="proTipText">Verwenden Sie Wildcards (*) um alle Subdomains zu erlauben. Zum Beispiel: <code>*.microsoft.com</code> erlaubt login.microsoft.com, account.microsoft.com, usw.<br><br><strong>Hinweis:</strong> Doppelte Domains werden automatisch entfernt.</p>
                </div>
            </div>
            
            <!-- Advanced Section (Collapsible) -->
            <div class="advanced-section">
                <div class="advanced-header" id="advancedHeader">
                    <h2>‚öôÔ∏è <span data-i18n="advancedSettings">Erweiterte Einstellungen</span></h2>
                    <span class="advanced-toggle">‚ñº</span>
                </div>
                <div class="advanced-content" id="advancedContent">
                    <div class="advanced-content-inner">
                        <!-- Boolean Options (All True/False Options from XML) -->
                        <div class="section">
                            <h2><span data-i18n="allBooleanOptions">Alle True-/False-Optionen</span></h2>
                            
                            <!-- Experimental Warning -->
                            <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px 15px;margin-bottom:20px;border-radius:4px;">
                                <strong style="color:#856404;">‚ö†Ô∏è <span data-i18n="experimentalFeature">Experimentelle Funktion</span></strong><br>
                                <span style="color:#856404;font-size:0.9em;" data-i18n="booleanOptionsWarning">
                                    Diese Funktion befindet sich in Entwicklung. Die Men√º-Referenzen werden schrittweise f√ºr alle Plattformen erg√§nzt. Verwenden Sie diese Optionen mit Vorsicht und testen Sie die generierte Konfiguration gr√ºndlich.
                                </span>
                            </div>
                            
                            <!-- Platform Selection for Boolean Options -->
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;padding:12px;background:#f5f7fb;border-radius:8px;border:1px solid #dfe6f0;">
                                <span style="font-weight:500;color:#2c3e5a;font-size:0.95em;">
                                    <span data-i18n="platformReference">üìö Men√º-Referenz f√ºr:</span>
                                </span>
                                <div style="display:flex;gap:8px;">
                                    <button class="platform-btn" data-platform="windows" onclick="selectPlatform('windows')" style="padding:6px 16px;border:2px solid #5b9bd5;border-radius:6px;background:#fff;color:#2c3e5a;cursor:pointer;font-weight:500;transition:all 0.2s;">
                                        üñ•Ô∏è Windows
                                    </button>
                                    <button class="platform-btn" data-platform="macos" onclick="selectPlatform('macos')" style="padding:6px 16px;border:2px solid #dfe6f0;border-radius:6px;background:#fff;color:#6c7a89;cursor:pointer;font-weight:500;transition:all 0.2s;">
                                        üçé macOS
                                    </button>
                                    <button class="platform-btn" data-platform="ipados" onclick="selectPlatform('ipados')" style="padding:6px 16px;border:2px solid #dfe6f0;border-radius:6px;background:#fff;color:#6c7a89;cursor:pointer;font-weight:500;transition:all 0.2s;">
                                        üì± iPadOS
                                    </button>
                                </div>
                            </div>
                            
                            <div id="booleanOptionsContainer"></div>
                        </div>
                        
                        <!-- Security Level -->
                        <div class="section">
                            <h2><span data-i18n="securityLevel">Sicherheitsstufe</span></h2>
                            <div class="security-level" id="securityLevel"></div>
                        </div>
                        
                        <!-- Preview & Download -->
                        <div class="section">
                            <h2><span data-i18n="previewAndDownload">Vorschau & Download</span></h2>
                            <div class="preview">
                                <h3><span data-i18n="allowedDomains">Erlaubte Domains</span> <span class="badge" id="domainCount">0</span></h3>
                                <div class="domain-list" id="domainPreview"></div>
                            </div>
                            <div class="actions">
                                <button class="btn btn-secondary" id="copyBtn">
                                    <span data-i18n="copyBtn">üìã Domain-Liste kopieren</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Network Capture Helper -->
                        <div class="section">
                            <div class="info-box" id="networkCaptureHelper">
                                <h4>üîß <span data-i18n="helperScriptTitle">Network Capture Helper</span></h4>
                                <p data-i18n="helperScriptText">
                                    Ben√∂tigen Sie Hilfe beim Erfassen von Netzwerk-Domains? W√§hlen Sie die passende Methode f√ºr Ihr System:
                                </p>
                                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    <a href="scripts/capture-helper.ps1" download class="btn btn-secondary" style="text-decoration: none; flex: 1; min-width: 200px;">
                                        <span data-i18n="downloadHelperBtn">‚¨áÔ∏è PowerShell (Windows)</span>
                                    </a>
                                    <button class="btn btn-secondary" id="browserHelperBtn" style="flex: 1; min-width: 200px;">
                                        <span data-i18n="browserHelperBtn">üåê Browser-Methode (Alle OS)</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Help Links -->
                        <div class="section">
                            <div style="padding: 15px; background: linear-gradient(135deg, #d4e6f7 0%, #e8f2fa 100%); border-left: 4px solid #5b9bd5; border-radius: 4px;">
                                <h4 style="color: #2c3e5a; margin-bottom: 12px;">üìñ <span data-i18n="advancedHelpTitle">Erweiterte Hilfe</span></h4>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <a href="#" id="browserCaptureLink" class="doc-link" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: #f5f7fb; color: #2c3e5a; border: 2px solid #5b9bd5; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                                        üåê <span data-i18n="browserCaptureLink">Browser Capture</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><span data-i18n="step4">4. Download</span></h2>
                <div class="actions">
                    <button class="btn btn-primary" id="generateBtn" style="width: 100%;">
                        <span data-i18n="downloadBtn">üì• SEB Konfiguration herunterladen (.seb)</span>
                    </button>
                </div>
                <div class="info-box">
                    <h4 data-i18n="nextStepsTitle">N√§chste Schritte</h4>
                    <p data-i18n="nextStepsText">
                        1. SEB-Konfigurationsdatei herunterladen (.seb)<br>
                        2. Im SEB Config Tool √∂ffnen<br>
                        3. Einstellungen verfeinern und verschl√ºsseln<br>
                        4. Als finale .seb-Datei speichern<br>
                        5. Verschl√ºsselte Datei an Sch√ºler*innen verteilen
                    </p>
                </div>
                
                <!-- Help Links - Basic Section -->
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #d4e6f7 0%, #e8f2fa 100%); border-left: 4px solid #5b9bd5; border-radius: 4px;">
                    <h4 style="color: #2c3e5a; margin-bottom: 12px;">üìñ <span data-i18n="helperDocsTitle">Hilfe & Anleitungen</span></h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="#" id="quickstartLinkBasic" class="doc-link" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: #f5f7fb; color: #2c3e5a; border: 2px solid #5b9bd5; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                            üöÄ <span data-i18n="quickstartLink">Schnellstart (Google Sites)</span>
                        </a>
                        <a href="#" id="quickRefLinkBasic" class="doc-link" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: #f5f7fb; color: #2c3e5a; border: 2px solid #5b9bd5; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
                            üìã <span data-i18n="quickRefLink">Schnellreferenz</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: center; padding: 20px; color: #8898aa; font-size: 0.85em;">
            <span id="versionInfo"></span>
        </div>
    </div>
    <script>
// ============================================================================
// TRANSLATIONS / √úBERSETZUNGEN
// ============================================================================
const TRANSLATIONS = {
    de: {
        title: "SEB Konfigurations-Generator",
        subtitle: "Erstellen Sie Safe Exam Browser Konfigurationen f√ºr Fokus-Modus im Unterricht",
        step1: "1. Dienst ausw√§hlen",
        groupNoLogin: "Ohne Anmeldung",
        groupWithLogin: "Mit Anmeldung",
        groupAllowedTools: "Erlaubte Hilfsmittel",
        selectSubject: "Fach ausw√§hlen",
        // Subject translations - add more as needed (subjectFrench, subjectSpanish, etc.)
        subjectGerman: "Deutsch",
        subjectEnglish: "Englisch",
        subjectFrench: "Franz√∂sisch",
        step2: "2. Konfigurationseinstellungen",
        step3: "3. Benutzerdefinierte Domains (Optional)",
        step4: "4. Download",
        advancedSettings: "Erweiterte Einstellungen",
        previewAndDownload: "Vorschau & Download",
        advancedHelpTitle: "Erweiterte Hilfe",
        startUrl: "Start-URL",
        configName: "Konfigurationsname",
        
        // SharePoint configuration
        sharepointLinkLabel: "SharePoint-Link (Optional - f√ºr erweiterte Filterung)",
        sharepointLinkPlaceholder: "https://schule.sharepoint.com/sites/...",
        sharepointOptionsTitle: "üìé SharePoint-Einschr√§nkungen",
        sharepointPastePrompt: "F√ºgen Sie einen SharePoint-Link ein, um erweiterte Filteroptionen zu aktivieren",
        sharepointHelpOneNote: "üí° OneNote: Rechtsklick auf Seite ‚Üí 'Link zu dieser Seite kopieren'. Achtung: Abschnitts- oder Seiteneinschr√§nkung nur sinnvoll in kollaborativen Bereichen/Abschnitten eines Notizbuchs (ausser reiner Lesezugriff reicht aus).",
        sharepointHelpWord: "üí° Word: Link aus Browser-Adresszeile kopieren (wenn Dokument ge√∂ffnet). Achtung bei Kollaboration: Datei muss in Ordner mit Schreibzugriff sein. F√ºr eigene Versionen: 'nur diese Datei' nicht ausw√§hlen ‚Üí Ordnerzugriff erm√∂glichen.",
        experimentalWarningTitle: "‚ö†Ô∏è Experimentelle Funktion",
        experimentalWarningText: "OneNote/Word Online mit SharePoint-Einschr√§nkungen ist in der Beta-Phase. Unbedingt gr√ºndlich testen, bevor die Konfiguration an Sch√ºler*innen verteilt wird. In vielen F√§llen funktioniert es nur, wenn Network Capture in exakt derselben Umgebung kurz vor dem Einsatz im Unterricht durchgef√ºhrt wird.",
        experimentalWarningLink: "‚Üí Network Capture Helper nutzen",
        restrictToSchoolSharepoint: "Nur SharePoint unserer Schule",
        restrictToTeamsSite: "Nur diese Teams-Site/Gruppe",
        restrictToNotebook: "Nur dieses Notizbuch",
        restrictToSection: "Nur dieser Abschnitt",
        restrictToPage: "Nur diese Seite",
        restrictToFolder: "Nur Dateien in diesem Ordner",
        restrictToFile: "Nur diese Datei",
        sharepointDetected: "SharePoint-Dom√§ne erkannt",
        teamsSiteDetected: "Teams-Site erkannt",
        notebookDetected: "Notizbuch erkannt",
        sectionDetected: "Abschnitt erkannt",
        pageDetected: "Seite erkannt",
        folderDetected: "Ordner erkannt",
        fileDetected: "Datei erkannt",
        securityLevel: "Sicherheitsstufe",
        securityLevelExperimentalTitle: "‚öôÔ∏è Experimentell",
        securityLevelExperimentalText: "Die Sicherheitsstufen 'Locker' und 'Streng' sind noch in Entwicklung und haben derzeit nur minimale Auswirkungen auf die Konfiguration.",
        
        // Boolean options groups
        allBooleanOptions: "Alle True-/False-Optionen",
        platformReference: "üìö Men√º-Referenz f√ºr:",
        experimentalFeature: "Experimentelle Funktion",
        booleanOptionsWarning: "Diese Funktion befindet sich in Entwicklung. Die Men√º-Referenzen werden schrittweise f√ºr alle Plattformen erg√§nzt. Verwenden Sie diese Optionen mit Vorsicht und testen Sie die generierte Konfiguration gr√ºndlich.",
        booleanOptionsInfo: "Diese Optionen werden dynamisch aus der SEB-Konfigurationsvorlage geladen. Standardwerte sind bereits gesetzt.",
        browserOptions: "üåê Browser-Einstellungen",
        securityOptions: "üîí Sicherheit & Zugriff",
        interfaceOptions: "üñ•Ô∏è Benutzeroberfl√§che",
        systemOptions: "‚öôÔ∏è System & Prozesse",
        networkOptions: "üåç Netzwerk",
        mobileOptions: "üì± Mobile (iOS/iPadOS)",
        otherOptions: "üìã Weitere Optionen",
        sebConfigToolLocation: "SEB Config Tool",
        
        additionalOptions: "Zus√§tzliche Optionen",
        allowDownloads: "Datei-Downloads erlauben",
        allowSpellCheck: "Rechtschreibpr√ºfung erlauben",
        showReloadButton: "Neu-Laden-Button anzeigen",
        allowBackForward: "Vor/Zur√ºck-Navigation erlauben",
        customDomainsLabel: "Zus√§tzliche erlaubte Domains hinzuf√ºgen (eine pro Zeile)",
        customDomainsPlaceholder: "beispiel.ch\n*.schule-domain.ch",
        blockedDomainsLabel: "Domains sperren (Optional, nur bei Wildcards in 'Zus√§tzliche Domains')",
        blockedDomainsPlaceholder: "# Beispiel: Falls Sie *.beispiel.ch erlauben\n# aber mail.beispiel.ch sperren m√∂chten:\nmail.beispiel.ch",
        proTipTitle: "üí° Profi-Tipp",
        proTipText: "Verwenden Sie Wildcards (*) um alle Subdomains zu erlauben. Zum Beispiel: *.microsoft.com erlaubt login.microsoft.com, account.microsoft.com, usw.<br><br><strong>Hinweis:</strong> Doppelte Domains werden automatisch entfernt.",
        allowedDomains: "Erlaubte Domains",
        downloadBtn: "üì• SEB Konfiguration herunterladen (.seb)",
        copyBtn: "üìã Domain-Liste kopieren",
        nextStepsTitle: "N√§chste Schritte",
        nextStepsText: "1. SEB-Konfigurationsdatei herunterladen (.seb)<br>2. Im SEB Config Tool √∂ffnen<br>3. Einstellungen verfeinern und verschl√ºsseln<br>4. Als finale .seb-Datei speichern<br>5. Verschl√ºsselte Datei an Sch√ºler*innen verteilen",
        helperScriptTitle: "Network Capture Helper",
        helperScriptText: "Ben√∂tigen Sie Hilfe beim Erfassen von Netzwerk-Domains? W√§hlen Sie die passende Methode f√ºr Ihr System:",
        downloadHelperBtn: "‚¨áÔ∏è PowerShell (Windows)",
        browserHelperBtn: "üåê Browser-Methode (Alle OS)",
        helperDocsTitle: "üìñ Hilfe & Anleitungen:",
        browserCaptureLink: "Browser Capture Anleitung",
        quickstartLink: "Schnellstart mit Google Sites",
        quickRefLink: "Schnellreferenz",
        mainDocLink: "Vollst√§ndige Anleitung",
        
        // Presets
        presetOnenote: "OneNote Online",
        presetOnenoteDesc: "Microsoft OneNote Web-Client",
        presetWord: "Word Online",
        presetWordDesc: "Microsoft Word Web-Client",
        presetTeams: "Microsoft Teams",
        presetTeamsDesc: "Teams Web-Client f√ºr Zusammenarbeit",
        presetGdocs: "Google Docs",
        presetGdocsDesc: "Google Workspace Dokumenteneditor",
        presetGsheets: "Google Tabellen",
        presetGsheetsDesc: "Google Workspace Tabellenkalkulation",
        presetWhiteboard: "Whiteboard.fi",
        presetWhiteboardDesc: "Kollaboratives Online-Whiteboard",
        presetPadlet: "Padlet",
        presetPadletDesc: "Digitale Pinnwand f√ºr Zusammenarbeit",
        presetKahoot: "Kahoot!",
        presetKahootDesc: "Gamifizierte Quizze und Umfragen",
        presetMentimeter: "Mentimeter",
        presetMentimeterDesc: "Live-Umfragen und interaktive Pr√§sentationen",
        presetMiro: "Miro",
        presetMiroDesc: "Digitales Whiteboard f√ºr Zusammenarbeit",
        presetSlido: "Slido",
        presetSlidoDesc: "Live Q&A und Umfragen",
        presetEtherpad: "Etherpad",
        presetEtherpadDesc: "Kollaboratives Textdokument",
        presetForms: "Microsoft Forms",
        presetFormsDesc: "Umfragen und Formulare (√∂ffentlich)",
        presetDuden: "Duden",
        presetDudenDesc: "Deutsches W√∂rterbuch und Rechtschreibung",
        presetDwds: "DWDS",
        presetDwdsDesc: "Digitales W√∂rterbuch der deutschen Sprache",
        presetOxford: "Oxford Dictionary",
        presetOxfordDesc: "Englisches Lernw√∂rterbuch",
        presetCambridge: "Cambridge Dictionary",
        presetCambridgeDesc: "Cambridge Englisch W√∂rterbuch",
        presetLarousse: "Larousse",
        presetLarousseDesc: "Franz√∂sisches W√∂rterbuch und Enzyklop√§die",
        presetReverso: "Reverso",
        presetReversoDesc: "Franz√∂sisches Kontext-W√∂rterbuch und √úbersetzung",
        
        // Security levels
        securityRelaxed: "Locker",
        securityRelaxedDesc: "Fokus-Modus - blockiert Ablenkungen, erlaubt Flexibilit√§t",
        securityBalanced: "Ausgewogen",
        securityBalancedDesc: "Empfohlen - gutes Gleichgewicht zwischen Sicherheit und Benutzerfreundlichkeit",
        securityStrict: "Streng",
        securityStrictDesc: "Maximale Einschr√§nkungen (kann Sch√ºler frustrieren)",
        
        // Messages
        copiedMsg: "‚úì Kopiert!",
        configNamePlaceholder: "Meine_Schule_",
        
        // Privacy
        privacyTitle: "Datenschutz:",
        privacyText: "Alle Daten werden ausschlie√ülich lokal in Ihrem Browser verarbeitet. Es werden keine Konfigurationsdaten oder Eingaben an unseren Server gesendet oder gespeichert. Nur Ihre Sprachpr√§ferenz wird lokal im Browser gespeichert.",
        suggestService: "Dienst oder Hilfsmittel vorschlagen / Problem melden",
        
        // Version info
        versionLabel: "Version",
        buildLabel: "Build"
    },
    en: {
        title: "SEB Config Generator",
        subtitle: "Create Safe Exam Browser configurations for educational focus mode",
        step1: "1. Choose Service",
        groupNoLogin: "No Login Required",
        groupWithLogin: "Login Required",
        groupAllowedTools: "Allowed Reference Tools",
        selectSubject: "Select Subject",
        // Subject translations - add more as needed (subjectFrench, subjectSpanish, etc.)
        subjectGerman: "German",
        subjectEnglish: "English",
        subjectFrench: "French",
        step2: "2. Configuration Settings",
        step3: "3. Custom Domains (Optional)",
        step4: "4. Download",
        advancedSettings: "Advanced Settings",
        previewAndDownload: "Preview & Download",
        advancedHelpTitle: "Advanced Help",
        startUrl: "Start URL",
        configName: "Configuration Name",
        
        // SharePoint configuration
        sharepointLinkLabel: "SharePoint Link (Optional - for advanced filtering)",
        sharepointLinkPlaceholder: "https://school.sharepoint.com/sites/...",
        sharepointOptionsTitle: "üìé SharePoint Restrictions",
        sharepointPastePrompt: "Paste a SharePoint link to enable advanced filtering options",
        sharepointHelpOneNote: "üí° OneNote: Right-click on page ‚Üí 'Copy link to this page'. Note: Section or page restrictions only make sense for collaborative sections/areas of a notebook (unless read-only access is sufficient).",
        sharepointHelpWord: "üí° Word: Copy link from browser address bar (when document is open). Note for collaboration: File must be in folder with write access. For saving own versions: Don't select 'only this file' ‚Üí enable folder access.",
        experimentalWarningTitle: "‚ö†Ô∏è Experimental Feature",
        experimentalWarningText: "OneNote/Word Online with SharePoint restrictions is in beta. Thoroughly test before deploying to students. In many cases it only works if Network Capture is run in exactly the same environment soon before the config is used in class.",
        experimentalWarningLink: "‚Üí Use Network Capture Helper",
        restrictToSchoolSharepoint: "Only our school's SharePoint",
        restrictToTeamsSite: "Only this Teams site/group",
        restrictToNotebook: "Only this notebook",
        restrictToSection: "Only this section",
        restrictToPage: "Only this page",
        restrictToFolder: "Only files in this folder",
        restrictToFile: "Only this file",
        sharepointDetected: "SharePoint domain detected",
        teamsSiteDetected: "Teams site detected",
        notebookDetected: "Notebook detected",
        sectionDetected: "Section detected",
        pageDetected: "Page detected",
        folderDetected: "Folder detected",
        fileDetected: "File detected",
        securityLevel: "Security Level",
        securityLevelExperimentalTitle: "‚öôÔ∏è Experimental",
        securityLevelExperimentalText: "The security levels 'Relaxed' and 'Strict' are still in development and currently have minimal impact on the configuration.",
        
        // Boolean options groups
        allBooleanOptions: "All True/False Options",
        platformReference: "üìö Menu Reference for:",
        experimentalFeature: "Experimental Feature",
        booleanOptionsWarning: "This feature is under development. Menu references are being added gradually for all platforms. Use these options with caution and thoroughly test the generated configuration.",
        booleanOptionsInfo: "These options are dynamically loaded from the SEB configuration template. Default values are already set.",
        browserOptions: "üåê Browser Settings",
        securityOptions: "üîí Security & Access",
        interfaceOptions: "üñ•Ô∏è User Interface",
        systemOptions: "‚öôÔ∏è System & Processes",
        networkOptions: "üåç Network",
        mobileOptions: "üì± Mobile (iOS/iPadOS)",
        otherOptions: "üìã Other Options",
        sebConfigToolLocation: "SEB Config Tool",
        
        additionalOptions: "Additional Options",
        allowDownloads: "Allow file downloads",
        allowSpellCheck: "Allow spell check",
        showReloadButton: "Show reload button",
        allowBackForward: "Allow back/forward navigation",
        customDomainsLabel: "Add additional allowed domains (one per line)",
        customDomainsPlaceholder: "example.ch\n*.school-domain.ch",
        blockedDomainsLabel: "Block domains (Optional, only needed for wildcards in 'Additional Domains')",
        blockedDomainsPlaceholder: "# Example: If you allow *.example.ch\n# but want to block mail.example.ch:\nmail.example.ch",
        proTipTitle: "üí° Pro Tip",
        proTipText: "Use wildcards (*) to allow all subdomains. For example: *.microsoft.com allows login.microsoft.com, account.microsoft.com, etc.<br><br><strong>Note:</strong> Duplicate domains are automatically removed.",
        allowedDomains: "Allowed Domains",
        downloadBtn: "üì• Download SEB Config (.seb)",
        copyBtn: "üìã Copy Domain List",
        nextStepsTitle: "Next Steps",
        nextStepsText: "1. Download the SEB configuration file (.seb)<br>2. Open in SEB Config Tool<br>3. Refine settings and encrypt<br>4. Save as final .seb file<br>5. Distribute encrypted file to students",
        helperScriptTitle: "Network Capture Helper",
        helperScriptText: "Need help capturing network domains? Choose the method that works for your system:",
        downloadHelperBtn: "‚¨áÔ∏è PowerShell (Windows)",
        browserHelperBtn: "üåê Browser Method (All OS)",
        helperDocsTitle: "üìñ Help & Guides:",
        browserCaptureLink: "Browser Capture Guide",
        quickstartLink: "Quick Start with Google Sites",
        quickRefLink: "Quick Reference",
        mainDocLink: "Complete Guide",
        
        // Presets
        presetOnenote: "OneNote Online",
        presetOnenoteDesc: "Microsoft OneNote web client",
        presetWord: "Word Online",
        presetWordDesc: "Microsoft Word web client",
        presetTeams: "Microsoft Teams",
        presetTeamsDesc: "Teams web client for collaboration",
        presetGdocs: "Google Docs",
        presetGdocsDesc: "Google Workspace document editor",
        presetGsheets: "Google Sheets",
        presetGsheetsDesc: "Google Workspace spreadsheet editor",
        presetWhiteboard: "Whiteboard.fi",
        presetWhiteboardDesc: "Collaborative online whiteboard",
        presetPadlet: "Padlet",
        presetPadletDesc: "Digital bulletin board for collaboration",
        presetKahoot: "Kahoot!",
        presetKahootDesc: "Gamified quizzes and polls",
        presetMentimeter: "Mentimeter",
        presetMentimeterDesc: "Live polls and interactive presentations",
        presetMiro: "Miro",
        presetMiroDesc: "Digital whiteboard for collaboration",
        presetSlido: "Slido",
        presetSlidoDesc: "Live Q&A and polls",
        presetEtherpad: "Etherpad",
        presetEtherpadDesc: "Collaborative text document",
        presetForms: "Microsoft Forms",
        presetFormsDesc: "Surveys and forms (public)",
        presetDuden: "Duden",
        presetDudenDesc: "German dictionary and spelling",
        presetDwds: "DWDS",
        presetDwdsDesc: "Digital Dictionary of German Language",
        presetOxford: "Oxford Dictionary",
        presetOxfordDesc: "English learner's dictionary",
        presetCambridge: "Cambridge Dictionary",
        presetCambridgeDesc: "Cambridge English Dictionary",
        presetLarousse: "Larousse",
        presetLarousseDesc: "French dictionary and encyclopedia",
        presetReverso: "Reverso",
        presetReversoDesc: "French contextual dictionary and translation",
        
        // Security levels
        securityRelaxed: "Relaxed",
        securityRelaxedDesc: "Focus mode - blocks distractions but allows flexibility",
        securityBalanced: "Balanced",
        securityBalancedDesc: "Recommended - good balance of security and usability",
        securityStrict: "Strict",
        securityStrictDesc: "Maximum restrictions (may frustrate students)",
        
        // Messages
        copiedMsg: "‚úì Copied!",
        configNamePlaceholder: "My_School_",
        
        // Privacy
        privacyTitle: "Privacy:",
        privacyText: "All data is processed locally in your browser. No configuration data or inputs are sent to or stored on our server. Only your language preference is saved locally in your browser.",
        suggestService: "Suggest Service or Tool / Report Issue",
        
        // Version info
        versionLabel: "Version",
        buildLabel: "Build"
    }
};

// ============================================================================
// PRESET CONFIGURATIONS
// ============================================================================
const PRESETS = {
    onenote: {
        startUrl: "https://www.onenote.com/notebooks",
        // Note: *.sharepoint.com covers school-specific SharePoint sites (e.g., school1.sharepoint.com)
        domains: ["*.microsoft.com","*.microsoftonline.com","*.msauth.net","*.msftauth.net","login.live.com","account.live.com","*.live.com","*.office.com","*.office.net","*.office365.com","*.officeapps.live.com","*.sharepoint.com","*.sharepointonline.com","*.onenote.com","onenote.officeapps.live.com","*.msocdn.com","*.msecnd.net","*.azureedge.net","*.windows.net","*.static.microsoft","browser.events.data.microsoft.com","chc-onenote.officeapps.live.com","common.online.office.com","euc-common.online.office.com","login.microsoftonline.com","res-1.cdn.office.net","res-1.public.onecdn.static.microsoft","wise-m.public.cdn.office.net","wise.public.cdn.office.net"],
        blockedDomains: ["outlook.office.com","outlook.office365.com","teams.microsoft.com","teams.live.com"]
    },
    word: {
        startUrl: "https://www.office.com/launch/word",
        // Note: *.sharepoint.com covers school-specific SharePoint sites (e.g., school1.sharepoint.com)
        domains: ["*.microsoft.com","*.microsoftonline.com","*.msauth.net","*.msftauth.net","login.live.com","account.live.com","*.live.com","*.office.com","*.office.net","*.office365.com","*.officeapps.live.com","*.sharepoint.com","*.sharepointonline.com","*.msocdn.com","*.msecnd.net","*.azureedge.net","*.windows.net","*.static.microsoft","browser.events.data.microsoft.com","common.online.office.com","euc-common.online.office.com","login.microsoftonline.com","res-1.cdn.office.net","res-1.public.onecdn.static.microsoft","wise-m.public.cdn.office.net","wise.public.cdn.office.net"],
        blockedDomains: ["outlook.office.com","outlook.office365.com","teams.microsoft.com","teams.live.com"]
    },
    whiteboard: {
        startUrl: "https://whiteboard.fi",
        domains: ["whiteboard.fi","whiteboard-storage-*.s3.*.amazonaws.com","cdn.jsdelivr.net","fonts.googleapis.com","fonts.gstatic.com"]
    },
    padlet: {
        startUrl: "https://padlet.com",
        domains: ["padlet.com","*.padlet.com","padlet.net","*.padlet.pics"]
    },
    kahoot: {
        startUrl: "https://kahoot.it",
        domains: ["kahoot.it","*.kahoot.it","kahoot.com","*.kahoot.com"]
    },
    mentimeter: {
        startUrl: "https://www.menti.com",
        domains: ["menti.com","*.menti.com","mentimeter.com","*.mentimeter.com"]
    },
    miro: {
        startUrl: "https://miro.com",
        domains: ["miro.com","*.miro.com","*.mirocdn.com"]
    },
    slido: {
        startUrl: "https://www.slido.com",
        domains: ["slido.com","*.slido.com","*.sli.do"]
    },
    etherpad: {
        startUrl: "https://etherpad.org",
        domains: ["etherpad.org","*.etherpad.org"]
    },
    forms: {
        startUrl: "https://forms.office.com",
        domains: ["forms.office.com","*.forms.office.com","*.microsoft.com","*.microsoftonline.com","*.office.com","*.office365.com","*.msocdn.com","*.msecnd.net","*.azureedge.net"]
    },
    duden: {
        startUrl: "https://www.duden.de",
        domains: ["duden.de","*.duden.de","*.doubleclick.net","*.googletagmanager.com","*.stroeerdigitalgroup.de","*.taboola.com","*.yieldlove.com","mitself.net"]
    },
    dwds: {
        startUrl: "https://www.dwds.de",
        domains: ["dwds.de","*.dwds.de"]
    },
    oxford: {
        startUrl: "https://www.oxfordlearnersdictionaries.com",
        domains: ["oxfordlearnersdictionaries.com","*.oxfordlearnersdictionaries.com","*.oup.com","*.cookielaw.org","*.doubleclick.net","*.google-analytics.com","*.google.com","*.googletagmanager.com","*.onetrust.com","*.polarbyte.com","html-load.com"]
    },
    cambridge: {
        startUrl: "https://dictionary.cambridge.org",
        domains: ["dictionary.cambridge.org","*.cambridge.org"]
    },
    larousse: {
        startUrl: "https://www.larousse.fr/dictionnaires",
        domains: ["larousse.fr","*.larousse.fr"]
    },
    reverso: {
        startUrl: "https://www.reverso.net/",
        domains: ["reverso.net","*.reverso.net","context.reverso.net"]
    }
};

// ============================================================================
// SUBJECTS CONFIGURATION - Easily extensible for additional languages
// ============================================================================
const SUBJECTS = {
    german: {
        toolPresets: ['duden', 'dwds']
    },
    english: {
        toolPresets: ['oxford', 'cambridge']
    },
    french: {
        toolPresets: ['larousse', 'reverso']
    }
    // Add more subjects here as needed:
    // spanish: { toolPresets: ['rae', 'wordreference'] },
    // italian: { toolPresets: ['treccani', 'dizionario'] }
};

const PRESET_GROUPS = {
    noLogin: ['whiteboard', 'kahoot', 'mentimeter', 'slido', 'forms', 'padlet', 'miro', 'etherpad'],
    withLogin: ['onenote', 'word'],
    // Generate allowedTools from SUBJECTS configuration
    allowedTools: Object.fromEntries(
        Object.entries(SUBJECTS).map(([key, config]) => [key, config.toolPresets])
    )
};

const SECURITY_LEVELS = {
    relaxed: {
        settings: {allowSwitchToApplications:false,allowQuit:true,browserViewMode:0,enableBrowserWindowToolbar:true,showMenuBar:false}
    },
    balanced: {
        settings: {allowSwitchToApplications:false,allowQuit:true,browserViewMode:0,enableBrowserWindowToolbar:true,showMenuBar:false}
    },
    strict: {
        settings: {allowSwitchToApplications:false,allowQuit:false,browserViewMode:1,enableBrowserWindowToolbar:false,showMenuBar:false}
    }
};

// ============================================================================
// SHAREPOINT LINK PARSING
// ============================================================================
function parseSharePointLink(url, serviceType) {
    if (!url || !url.trim()) return null;
    
    try {
        const result = {
            isSharePoint: false,
            domain: null,
            teamsSite: null,
            notebook: null,
            section: null,
            pageName: null,
            pageId: null,
            sectionId: null,
            folder: null,
            fileName: null,
            fileId: null
        };
        
        // OneNote links often contain two parts separated by space: web URL and onenote: protocol
        // Example: "https://.../_layouts/Doc.aspx?... onenote:https://.../Notebook/Section.one#PageName&section-id={...}&page-id={...}"
        let webUrl = url;
        let oneNoteProtocolUrl = null;
        
        if (url.includes(' onenote:')) {
            const parts = url.split(' onenote:');
            webUrl = parts[0].trim();
            oneNoteProtocolUrl = 'https:' + parts[1].trim(); // Re-add https: prefix
        }
        
        const parsed = new URL(webUrl);
        
        // Check if it's a SharePoint URL
        if (!parsed.hostname.includes('sharepoint.com')) {
            return null;
        }
        
        result.isSharePoint = true;
        result.domain = parsed.hostname;
        
        // Extract Teams site (e.g., /sites/msteams_763fd2/)
        const siteMatch = parsed.pathname.match(/\/sites\/([^\/]+)/);
        if (siteMatch) {
            result.teamsSite = siteMatch[1];
        }
        
        if (serviceType === 'onenote') {
            // If we have the onenote: protocol URL, parse it for precise information
            if (oneNoteProtocolUrl) {
                try {
                    const oneNoteUrl = new URL(oneNoteProtocolUrl);
                    
                    // Extract notebook name from path: /SiteAssets/Englisch%20G22e-Notizbuch/
                    const notebookMatch = oneNoteUrl.pathname.match(/\/SiteAssets\/([^\/]+)/);
                    if (notebookMatch) {
                        result.notebook = decodeURIComponent(notebookMatch[1]);
                    }
                    
                    // Extract section (.one file): /_Inhaltsbibliothek/Language%20Hub%20(Years%203-4).one
                    const sectionMatch = oneNoteUrl.pathname.match(/\/([^\/]+\.one)/i);
                    if (sectionMatch) {
                        result.section = decodeURIComponent(sectionMatch[1]);
                    }
                    
                    // Extract page name from hash: #Participle%20clauses
                    if (oneNoteUrl.hash) {
                        const pageNameMatch = oneNoteUrl.hash.match(/#([^&]+)/);
                        if (pageNameMatch) {
                            result.pageName = decodeURIComponent(pageNameMatch[1]);
                        }
                    }
                    
                    // Extract section-id from hash
                    const sectionIdMatch = oneNoteUrl.hash.match(/section-id=\{([^}]+)\}/);
                    if (sectionIdMatch) {
                        result.sectionId = sectionIdMatch[1];
                    }
                    
                    // Extract page-id from hash
                    const pageIdMatch = oneNoteUrl.hash.match(/page-id=\{([^}]+)\}/);
                    if (pageIdMatch) {
                        result.pageId = pageIdMatch[1];
                    }
                } catch (e) {
                    // Fallback to web URL parsing if onenote: URL parsing fails
                    console.warn('OneNote protocol URL parsing failed, falling back to web URL', e);
                }
            }
            
            // Fallback: try to extract from web URL if onenote: protocol wasn't available
            if (!result.notebook) {
                const notebookMatch = webUrl.match(/\/([^\/]+)-Notizbuch/i);
                if (notebookMatch) {
                    result.notebook = decodeURIComponent(notebookMatch[1] + '-Notizbuch');
                }
            }
            
            if (!result.section) {
                const sectionMatch = webUrl.match(/\/([^\/]+\.one)/i);
                if (sectionMatch) {
                    result.section = decodeURIComponent(sectionMatch[1]);
                }
            }
            
            // Extract section-id and page-id from wd=target(...) parameter (web URL format)
            // Format: wd=target(SectionPath.one|{SECTION-ID}/PageName|{PAGE-ID}/)
            if (!result.sectionId || !result.pageId) {
                const wdMatch = webUrl.match(/[&?]wd=([^&]+)/);
                if (wdMatch) {
                    const wdDecoded = decodeURIComponent(wdMatch[1]);
                    
                    // Extract section ID: .one|{GUID}/
                    if (!result.sectionId) {
                        const sectionIdMatch = wdDecoded.match(/\.one\|([A-F0-9-]+)\//i);
                        if (sectionIdMatch) {
                            result.sectionId = sectionIdMatch[1];
                        }
                    }
                    
                    // Extract page ID: Must come AFTER the section ID pattern
                    // Look for: /PageName|{GUID}/ that comes after .one|{SECTION-ID}/
                    if (!result.pageId) {
                        const afterSection = wdDecoded.match(/\.one\|[A-F0-9-]+\/(.+)/i);
                        if (afterSection) {
                            const pageIdMatch = afterSection[1].match(/\|([A-F0-9-]+)\//i);
                            if (pageIdMatch) {
                                result.pageId = pageIdMatch[1];
                            }
                        }
                    }
                }
            }
        } else if (serviceType === 'word') {
            // Extract file ID (sourcedoc)
            const fileIdMatch = url.match(/sourcedoc[=%]+\{([^}]+)\}/i);
            if (fileIdMatch) {
                result.fileId = fileIdMatch[1];
            }
            
            // Extract file name from path
            const fileNameMatch = parsed.pathname.match(/\/([^\/]+\.docx?)$/i);
            if (fileNameMatch) {
                result.fileName = decodeURIComponent(fileNameMatch[1]);
            }
            
            // Extract folder from path (between /sites/xxx/ and the file)
            const folderMatch = parsed.pathname.match(/\/sites\/[^\/]+\/(.+?)\/[^\/]+\.docx?/i);
            if (folderMatch) {
                result.folder = decodeURIComponent(folderMatch[1]);
            }
        }
        
        return result;
    } catch (e) {
        return null;
    }
}

// ============================================================================
// XML PARSER FOR BOOLEAN OPTIONS
// ============================================================================
async function loadAndParseBooleanOptions() {
    try {
        console.log('üì• Fetching XML template...');
        const response = await fetch('templates/example_config.xml');
        console.log('üìÑ Response status:', response.status);
        const xmlText = await response.text();
        console.log('üìù XML text length:', xmlText.length);
        
        // Parse XML
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        // Extract all boolean options
        const allKeys = xmlDoc.getElementsByTagName('key');
        const optionsMap = new Map(); // Use Map to automatically handle duplicates
        
        for (let i = 0; i < allKeys.length; i++) {
            const keyElement = allKeys[i];
            const keyName = keyElement.textContent.trim();
            const nextSibling = keyElement.nextElementSibling;
            
            // Check if the next element is <true/> or <false/>
            if (nextSibling && (nextSibling.tagName === 'true' || nextSibling.tagName === 'false')) {
                const defaultValue = nextSibling.tagName === 'true';
                // Only add if not already in map (first occurrence wins)
                if (!optionsMap.has(keyName)) {
                    optionsMap.set(keyName, { key: keyName, defaultValue });
                }
            }
        }
        
        // Convert Map to Array
        const options = Array.from(optionsMap.values());
        
        // Categorize options into groups
        const groups = {
            browser: { title: 'browserOptions', options: [] },
            security: { title: 'securityOptions', options: [] },
            interface: { title: 'interfaceOptions', options: [] },
            system: { title: 'systemOptions', options: [] },
            network: { title: 'networkOptions', options: [] },
            mobile: { title: 'mobileOptions', options: [] },
            other: { title: 'otherOptions', options: [] }
        };
        
        // Categorize each option
        options.forEach(opt => {
            const key = opt.key;
            let group = 'other';
            
            // Browser-related
            if (key.match(/browser|window|page|zoom|plugin|java|pdf|popup|webview|reload|url|navigation|addressbar/i)) {
                group = 'browser';
            }
            // Security-related
            else if (key.match(/allow|prohibit|block|hook|detect|monitor|quit|exit|password|security|proctoring|screenshot|capture|recording|virtual|mirroring|sharing|switch/i)) {
                group = 'security';
            }
            // Interface/UI-related
            else if (key.match(/show|hide|enable|disable|display|toolbar|menu|button|icon|status|appearance/i)) {
                group = 'interface';
            }
            // Mobile-specific
            else if (key.match(/mobile|ios|ipad|touch|asam|aac|guided|orientation|formfactor/i)) {
                group = 'mobile';
            }
            // System-related
            else if (key.match(/process|application|desktop|shell|task|update|install|log|audio|battery|wlan/i)) {
                group = 'system';
            }
            // Network-related
            else if (key.match(/network|socket|ping|dns/i)) {
                group = 'network';
            }
            
            groups[group].options.push(opt);
        });
        
        // Store parsed data
        parsedBooleanOptions.groups = groups;
        parsedBooleanOptions.options = {};
        options.forEach(opt => {
            parsedBooleanOptions.options[opt.key] = opt.defaultValue;
            parsedBooleanOptions.userSelections[opt.key] = opt.defaultValue; // Initialize with defaults
        });
        
        console.log(`‚úÖ Parsed ${options.length} boolean options from XML`);
        console.log('üìä Groups distribution:');
        Object.keys(groups).forEach(key => {
            console.log(`   - ${key}: ${groups[key].options.length} options`);
        });
        return true;
    } catch (error) {
        console.error('Failed to load/parse boolean options from XML:', error);
        return false;
    }
}

// ============================================================================
// LOAD BOOLEAN OPTIONS LOCATIONS FROM JSON (PLATFORM-SPECIFIC)
// ============================================================================
let booleanOptionsLocations = {};

async function loadBooleanOptionsLocations(platform = 'windows') {
    // Check if already loaded for this platform
    if (booleanOptionsLocations[platform]) {
        return booleanOptionsLocations[platform];
    }
    
    try {
        console.log(`üìç Loading boolean options locations for ${platform}...`);
        const response = await fetch(`templates/boolean-options-locations-${platform}.json`);
        const data = await response.json();
        booleanOptionsLocations[platform] = data;
        
        const optionCount = Object.keys(data.options).length;
        const versionInfo = data._metadata.sebVersion !== 'TBD' ? ` (SEB v${data._metadata.sebVersion})` : '';
        console.log(`‚úÖ Loaded locations for ${optionCount} options${versionInfo}`);
        return data;
    } catch (error) {
        console.error(`Failed to load boolean options locations for ${platform}:`, error);
        return null;
    }
}

function getOptionLocation(key) {
    const platformData = booleanOptionsLocations[currentPlatform];
    if (!platformData || !platformData.options || !platformData.options[key]) {
        return null;
    }
    
    const optionData = platformData.options[key];
    
    // For Windows format (with macDifferent field)
    if (currentPlatform === 'windows') {
        const windowsLoc = optionData.windows;
        const macDiff = optionData.macDifferent;
        
        if (macDiff) {
            return `${windowsLoc} (Mac: ${macDiff})`;
        }
        return windowsLoc;
    }
    
    // For macOS/iPadOS format (direct location)
    return optionData.location || optionData.windows || null;
}

function getTranslatedText(key) {
    const platformData = booleanOptionsLocations[currentPlatform];
    if (!platformData || !platformData._translations || !platformData._translations[currentLang]) {
        return key === 'notDocumented' ? 
            (currentLang === 'de' ? 'Noch nicht dokumentiert' : 'Not yet documented') :
            (currentLang === 'de' ? 'Diese Option ist noch nicht in der Dokumentation erfasst' : 'This option is not yet documented');
    }
    return platformData._translations[currentLang][key];
}

// Platform selection handler
async function selectPlatform(platform) {
    console.log(`üîÑ Switching to ${platform} platform...`);
    currentPlatform = platform;
    
    // Update button styles
    document.querySelectorAll('.platform-btn').forEach(btn => {
        const btnPlatform = btn.getAttribute('data-platform');
        if (btnPlatform === platform) {
            btn.style.borderColor = '#5b9bd5';
            btn.style.color = '#2c3e5a';
            btn.style.background = '#e8f2fa';
        } else {
            btn.style.borderColor = '#dfe6f0';
            btn.style.color = '#6c7a89';
            btn.style.background = '#fff';
        }
    });
    
    // Load locations for this platform if not already loaded
    await loadBooleanOptionsLocations(platform);
    
    // Re-render options to show new locations
    renderBooleanOptions();
    console.log(`‚úÖ Switched to ${platform} platform`);
}

// Generate human-readable label from key name
function generateOptionLabel(key) {
    // Remove common prefixes
    let label = key.replace(/^(allow|enable|show|display|disable|hide|block|force|create|detect|mobile|browser|new|exam|inside|config)/, '');
    
    // Insert spaces before capital letters
    label = label.replace(/([A-Z])/g, ' $1').trim();
    
    // Capitalize first letter
    label = label.charAt(0).toUpperCase() + label.slice(1);
    
    return label || key;
}

// ============================================================================
// VERSION & BUILD INFO
// ============================================================================
const APP_VERSION = 'v0.18.0a2';
const BUILD_DATE = new Date('2025-11-12T08:15:00'); // Format: YYYY-MM-DDTHH:mm:ss

function formatBuildDate(lang) {
    const day = String(BUILD_DATE.getDate()).padStart(2, '0');
    const month = String(BUILD_DATE.getMonth() + 1).padStart(2, '0');
    const year = BUILD_DATE.getFullYear();
    const hours = String(BUILD_DATE.getHours()).padStart(2, '0');
    const minutes = String(BUILD_DATE.getMinutes()).padStart(2, '0');
    
    if (lang === 'de') {
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    } else {
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    }
}

// ============================================================================
// STATE
// ============================================================================
let currentLang = 'de';
let selectedPresets = []; // Start with no preset selected - user must choose
let currentSecurityLevel = 'balanced';
let currentSelectedSubject = ''; // Track selected subject for allowed tools

// SharePoint link state
let sharepointConfig = {
    onenote: { parsedLink: null, restrictions: {} },
    word: { parsedLink: null, restrictions: {} }
};

// Boolean options parsed from XML template (lazy loaded on demand)
let parsedBooleanOptions = {
    loaded: false, // Track if options have been loaded
    groups: {},
    options: {},
    userSelections: {} // Track user's checkbox selections
};

// Platform selection for boolean options reference
let currentPlatform = 'windows'; // Default platform

// ============================================================================
// LANGUAGE MANAGEMENT
// ============================================================================
function setLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;
    
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (TRANSLATIONS[lang][key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = TRANSLATIONS[lang][key];
            } else {
                el.innerHTML = TRANSLATIONS[lang][key];
            }
        }
    });
    
    // Update placeholder attributes
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (TRANSLATIONS[lang][key]) {
            el.placeholder = TRANSLATIONS[lang][key];
        }
    });
    
    // Update language toggle buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    
    // Update documentation links based on language
    updateDocLinks(lang);
    
    // Update version info
    updateVersionInfo(lang);
    
    // Update SharePoint help text if visible
    const sharepointHelp = document.getElementById('sharepointHelp');
    if (sharepointHelp && sharepointHelp.style.display !== 'none') {
        const hasOneNote = selectedPresets.includes('onenote');
        const hasWord = selectedPresets.includes('word');
        
        if (hasOneNote && !hasWord) {
            sharepointHelp.textContent = t('sharepointHelpOneNote');
        } else if (hasWord && !hasOneNote) {
            sharepointHelp.textContent = t('sharepointHelpWord');
        } else if (hasOneNote && hasWord) {
            sharepointHelp.textContent = t('sharepointHelpOneNote') + '\n\n' + t('sharepointHelpWord');
        }
    }
    
    // Re-render boolean options if they are already loaded (to update translated hint texts)
    if (parsedBooleanOptions.loaded) {
        renderBooleanOptions();
    }
    
    // Re-render dynamic content
    renderPresets();
    renderSecurityLevels();
    
    // Save language preference
    localStorage.setItem('sebConfigLang', lang);
}

function updateVersionInfo(lang) {
    const versionInfo = document.getElementById('versionInfo');
    if (versionInfo) {
        const versionLabel = t('versionLabel');
        const buildLabel = t('buildLabel');
        const buildDate = formatBuildDate(lang);
        versionInfo.innerHTML = `${versionLabel}: ${APP_VERSION} | ${buildLabel}: ${buildDate}`;
    }
}

function updateDocLinks(lang) {
    // Base GitHub URL for rendered markdown
    const baseGitHubUrl = 'https://github.com/markuskiller/SEBConfigGenerator/blob/main/';
    
    // Main documentation link in header
    const mainDocLink = document.getElementById('mainDocLink');
    if (mainDocLink) {
        if (lang === 'de') {
            mainDocLink.href = baseGitHubUrl + 'docs/de/SCHNELLSTART_ANLEITUNG.md';
        } else {
            mainDocLink.href = baseGitHubUrl + 'docs/en/TEACHER_GUIDE.md';
        }
    }
    
    // Browser capture guide (in Advanced section)
    const browserCaptureLink = document.getElementById('browserCaptureLink');
    if (browserCaptureLink) {
        if (lang === 'de') {
            browserCaptureLink.href = baseGitHubUrl + 'docs/de/BROWSER_CAPTURE_ANLEITUNG.md';
        } else {
            browserCaptureLink.href = baseGitHubUrl + 'docs/en/BROWSER_CAPTURE_GUIDE.md';
        }
    }
    
    // Quickstart/Sites guide (in Basic section)
    const quickstartLinkBasic = document.getElementById('quickstartLinkBasic');
    if (quickstartLinkBasic) {
        if (lang === 'de') {
            quickstartLinkBasic.href = baseGitHubUrl + 'docs/de/SCHNELLSTART_ANLEITUNG.md';
        } else {
            quickstartLinkBasic.href = baseGitHubUrl + 'docs/en/TEACHER_GUIDE.md';
        }
    }
    
    // Quick reference (in Basic section)
    const quickRefLinkBasic = document.getElementById('quickRefLinkBasic');
    if (quickRefLinkBasic) {
        if (lang === 'de') {
            quickRefLinkBasic.href = baseGitHubUrl + 'docs/de/SCHNELLREFERENZ.txt';
        } else {
            quickRefLinkBasic.href = baseGitHubUrl + 'docs/en/QUICK_REFERENCE.txt';
        }
    }
}

function t(key) {
    return TRANSLATIONS[currentLang][key] || key;
}

// ============================================================================
// UI RENDERING
// ============================================================================
function renderPresets() {
    const container = document.getElementById('presetButtons');
    container.innerHTML = '';
    
    // Group 1: No Login Required
    const group1Title = document.createElement('h3');
    group1Title.style.cssText = 'color: #2c3e5a; margin: 20px 0 15px 0; font-size: 1.1em; grid-column: 1 / -1;';
    group1Title.innerHTML = `üåê ${t('groupNoLogin')}`;
    container.appendChild(group1Title);
    
    PRESET_GROUPS.noLogin.forEach(key => {
        const btn = document.createElement('button');
        btn.className = `preset-btn ${selectedPresets.includes(key) ? 'active' : ''}`;
        btn.innerHTML = `
            <h3>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1))}</h3>
            <p>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1) + 'Desc')}</p>
        `;
        btn.onclick = () => togglePreset(key);
        container.appendChild(btn);
    });
    
    // Group 2: Login Required
    const group2Title = document.createElement('h3');
    group2Title.style.cssText = 'color: #2c3e5a; margin: 30px 0 15px 0; font-size: 1.1em; grid-column: 1 / -1;';
    group2Title.innerHTML = `üîê ${t('groupWithLogin')}`;
    container.appendChild(group2Title);
    
    PRESET_GROUPS.withLogin.forEach(key => {
        const btn = document.createElement('button');
        btn.className = `preset-btn ${selectedPresets.includes(key) ? 'active' : ''}`;
        btn.innerHTML = `
            <h3>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1))}</h3>
            <p>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1) + 'Desc')}</p>
        `;
        btn.onclick = () => togglePreset(key);
        container.appendChild(btn);
    });
    
    // Experimental warning for OneNote and Word (shown when either is selected)
    let experimentalWarning = document.getElementById('experimentalWarning');
    if (!experimentalWarning) {
        // Create warning element if it doesn't exist
        experimentalWarning = document.createElement('div');
        experimentalWarning.id = 'experimentalWarning';
        experimentalWarning.style.cssText = 'background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin:20px 0;border-radius:4px;color:#856404;grid-column: 1 / -1;';
        
        const warningTitle = document.createElement('strong');
        warningTitle.style.cssText = 'display:block;margin-bottom:8px;font-size:1.05em;';
        experimentalWarning.appendChild(warningTitle);
        
        const warningText = document.createElement('div');
        warningText.style.cssText = 'font-size:0.95em;line-height:1.5;margin-bottom:8px;';
        experimentalWarning.appendChild(warningText);
        
        const warningLink = document.createElement('a');
        warningLink.href = '#networkCaptureHelper';
        warningLink.style.cssText = 'color:#856404;font-weight:600;text-decoration:underline;cursor:pointer;';
        experimentalWarning.appendChild(warningLink);
        
        container.appendChild(experimentalWarning);
    }
    
    // Update warning visibility and content
    const hasOneNote = selectedPresets.includes('onenote');
    const hasWord = selectedPresets.includes('word');
    const hasOneNoteOrWord = hasOneNote || hasWord;
    
    if (hasOneNoteOrWord) {
        experimentalWarning.style.display = 'block';
        const warningTitle = experimentalWarning.querySelector('strong');
        const warningText = experimentalWarning.querySelector('div');
        const warningLink = experimentalWarning.querySelector('a');
        warningTitle.textContent = t('experimentalWarningTitle');
        
        // Replace "Network Capture" with a link in the warning text
        const text = t('experimentalWarningText');
        const linkText = '<a href="#networkCaptureHelper" style="color:#856404;font-weight:600;text-decoration:underline;">Network Capture</a>';
        warningText.innerHTML = text.replace('Network Capture', linkText);
        
        warningLink.textContent = t('experimentalWarningLink');
    } else {
        experimentalWarning.style.display = 'none';
    }
    
    // Group 3: Allowed Tools (with subject selection)
    const group3Title = document.createElement('h3');
    group3Title.style.cssText = 'color: #2c3e5a; margin: 30px 0 15px 0; font-size: 1.1em; grid-column: 1 / -1;';
    group3Title.innerHTML = `üìö ${t('groupAllowedTools')}`;
    container.appendChild(group3Title);
    
    // Subject selector - dynamically generated from SUBJECTS configuration
    const subjectSelector = document.createElement('div');
    subjectSelector.style.cssText = 'grid-column: 1 / -1; margin-bottom: 15px;';
    
    const subjectLabel = document.createElement('label');
    subjectLabel.style.cssText = 'color: #2c3e5a; font-weight: 600; display: block; margin-bottom: 8px;';
    subjectLabel.textContent = `${t('selectSubject')}:`;
    subjectSelector.appendChild(subjectLabel);
    
    const subjectSelect = document.createElement('select');
    subjectSelect.id = 'subjectSelect';
    subjectSelect.style.cssText = 'width: 100%; padding: 10px; border: 2px solid #dfe6f0; border-radius: 8px; background: #f5f7fb; color: #2c3e5a; font-size: 1em; cursor: pointer;';
    
    // Default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = `-- ${t('selectSubject')} --`;
    subjectSelect.appendChild(defaultOption);
    
    // Dynamically add options from SUBJECTS configuration
    Object.keys(SUBJECTS).forEach(subjectKey => {
        const option = document.createElement('option');
        option.value = subjectKey;
        // Capitalize first letter for translation key: german -> subjectGerman
        const translationKey = 'subject' + subjectKey.charAt(0).toUpperCase() + subjectKey.slice(1);
        option.textContent = t(translationKey);
        subjectSelect.appendChild(option);
    });
    
    subjectSelector.appendChild(subjectSelect);
    container.appendChild(subjectSelector);
    
    // Tools container (initially hidden)
    const toolsContainer = document.createElement('div');
    toolsContainer.id = 'allowedToolsContainer';
    toolsContainer.style.cssText = 'grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;';
    container.appendChild(toolsContainer);
    
    // Add event listener to subject selector and restore previous selection
    setTimeout(() => {
        const select = document.getElementById('subjectSelect');
        if (select) {
            // Restore previously selected subject
            if (currentSelectedSubject) {
                select.value = currentSelectedSubject;
                renderAllowedTools(currentSelectedSubject);
            }
            select.addEventListener('change', (e) => renderAllowedTools(e.target.value));
        }
    }, 0);
}

function renderAllowedTools(subject) {
    const container = document.getElementById('allowedToolsContainer');
    if (!container) return;
    
    // Store the selected subject
    currentSelectedSubject = subject;
    
    container.innerHTML = '';
    
    if (!subject || !PRESET_GROUPS.allowedTools[subject]) return;
    
    PRESET_GROUPS.allowedTools[subject].forEach(key => {
        const btn = document.createElement('button');
        btn.className = `preset-btn ${selectedPresets.includes(key) ? 'active' : ''}`;
        btn.innerHTML = `
            <h3>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1))}</h3>
            <p>${t('preset' + key.charAt(0).toUpperCase() + key.slice(1) + 'Desc')}</p>
        `;
        btn.onclick = () => togglePreset(key);
        container.appendChild(btn);
    });
}

function renderSecurityLevels() {
    const container = document.getElementById('securityLevel');
    container.innerHTML = '';
    
    ['relaxed', 'balanced', 'strict'].forEach(key => {
        const div = document.createElement('div');
        div.className = `security-option ${key === currentSecurityLevel ? 'active' : ''}`;
        div.innerHTML = `
            <h4>${t('security' + key.charAt(0).toUpperCase() + key.slice(1))}</h4>
            <p>${t('security' + key.charAt(0).toUpperCase() + key.slice(1) + 'Desc')}</p>
        `;
        div.onclick = () => selectSecurityLevel(key);
        container.appendChild(div);
    });
    
    // Show/update experimental warning for relaxed and strict levels
    updateSecurityLevelWarning();
}

function renderSharePointOptions(serviceType, parsedLink) {
    const container = document.getElementById('sharepointOptions');
    if (!parsedLink || !parsedLink.isSharePoint) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
    }
    
    container.style.display = 'block';
    container.innerHTML = '';
    
    // Title
    const title = document.createElement('h4');
    title.style.cssText = 'color: #2c3e5a; margin: 0 0 10px 0; font-size: 0.95em;';
    title.textContent = t('sharepointOptionsTitle');
    container.appendChild(title);
    
    const optionsDiv = document.createElement('div');
    optionsDiv.style.cssText = 'background: #f5f7fb; border-radius: 8px; padding: 15px; border: 2px solid #dfe6f0;';
    
    // School SharePoint option
    if (parsedLink.domain) {
        const checkbox = createSharePointCheckbox(
            serviceType,
            'schoolSharepoint',
            t('restrictToSchoolSharepoint'),
            `${t('sharepointDetected')}: ${parsedLink.domain}`
        );
        optionsDiv.appendChild(checkbox);
    }
    
    // Teams site option
    if (parsedLink.teamsSite) {
        const checkbox = createSharePointCheckbox(
            serviceType,
            'teamsSite',
            t('restrictToTeamsSite'),
            `${t('teamsSiteDetected')}: ${parsedLink.teamsSite}`
        );
        optionsDiv.appendChild(checkbox);
    }
    
    // OneNote-specific options
    if (serviceType === 'onenote') {
        if (parsedLink.notebook) {
            const checkbox = createSharePointCheckbox(
                serviceType,
                'notebook',
                t('restrictToNotebook'),
                `${t('notebookDetected')}: ${parsedLink.notebook}`
            );
            optionsDiv.appendChild(checkbox);
        }
        
        if (parsedLink.section) {
            const checkbox = createSharePointCheckbox(
                serviceType,
                'section',
                t('restrictToSection'),
                `${t('sectionDetected')}: ${parsedLink.section}`
            );
            optionsDiv.appendChild(checkbox);
        }
        
        if (parsedLink.pageId) {
            const detectedInfo = parsedLink.pageName 
                ? `${t('pageDetected')}: ${parsedLink.pageName}`
                : `${t('pageDetected')}`;
            const checkbox = createSharePointCheckbox(
                serviceType,
                'page',
                t('restrictToPage'),
                detectedInfo
            );
            optionsDiv.appendChild(checkbox);
        }
    }
    
    // Word-specific options
    if (serviceType === 'word') {
        if (parsedLink.folder) {
            const checkbox = createSharePointCheckbox(
                serviceType,
                'folder',
                t('restrictToFolder'),
                `${t('folderDetected')}: ${parsedLink.folder}`
            );
            optionsDiv.appendChild(checkbox);
        }
        
        if (parsedLink.fileId) {
            const checkbox = createSharePointCheckbox(
                serviceType,
                'file',
                t('restrictToFile'),
                `${t('fileDetected')}`
            );
            optionsDiv.appendChild(checkbox);
        }
    }
    
    container.appendChild(optionsDiv);
}

function createSharePointCheckbox(serviceType, restrictionType, label, detectedInfo) {
    const div = document.createElement('div');
    div.style.cssText = 'margin-bottom: 10px;';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `sp_${serviceType}_${restrictionType}`;
    checkbox.style.cssText = 'margin-right: 8px;';
    checkbox.onchange = () => {
        if (!sharepointConfig[serviceType].restrictions) {
            sharepointConfig[serviceType].restrictions = {};
        }
        sharepointConfig[serviceType].restrictions[restrictionType] = checkbox.checked;
        updatePreview();
    };
    
    const labelEl = document.createElement('label');
    labelEl.htmlFor = checkbox.id;
    labelEl.style.cssText = 'color: #2c3e5a; font-weight: 600; cursor: pointer;';
    labelEl.textContent = label;
    
    const infoEl = document.createElement('div');
    infoEl.style.cssText = 'margin-left: 28px; font-size: 0.85em; color: #5b9bd5;';
    infoEl.textContent = detectedInfo;
    
    div.appendChild(checkbox);
    div.appendChild(labelEl);
    div.appendChild(infoEl);
    
    return div;
}

function togglePreset(key) {
    // Check if this is an allowed tool (Hilfsmittel)
    const isAllowedTool = Object.values(PRESET_GROUPS.allowedTools).flat().includes(key);
    
    const index = selectedPresets.indexOf(key);
    if (index === -1) {
        selectedPresets.push(key);
    } else {
        selectedPresets.splice(index, 1);
    }
    
    // Show/hide SharePoint link field for OneNote and Word
    const sharepointLinkGroup = document.getElementById('sharepointLinkGroup');
    const sharepointHelp = document.getElementById('sharepointHelp');
    const hasOneNote = selectedPresets.includes('onenote');
    const hasWord = selectedPresets.includes('word');
    const hasOneNoteOrWord = hasOneNote || hasWord;
    
    sharepointLinkGroup.style.display = hasOneNoteOrWord ? 'block' : 'none';
    
    // Update experimental warning visibility (created in renderPresets)
    const experimentalWarning = document.getElementById('experimentalWarning');
    if (experimentalWarning) {
        if (hasOneNoteOrWord) {
            experimentalWarning.style.display = 'block';
            const warningTitle = experimentalWarning.querySelector('strong');
            const warningText = experimentalWarning.querySelector('div');
            const warningLink = experimentalWarning.querySelector('a');
            warningTitle.textContent = t('experimentalWarningTitle');
            
            // Replace "Network Capture" with a link in the warning text
            const text = t('experimentalWarningText');
            const linkText = '<a href="#networkCaptureHelper" style="color:#856404;font-weight:600;text-decoration:underline;">Network Capture</a>';
            warningText.innerHTML = text.replace('Network Capture', linkText);
            
            warningLink.textContent = t('experimentalWarningLink');
        } else {
            experimentalWarning.style.display = 'none';
        }
    }
    
    // Show appropriate help text
    if (hasOneNote && !hasWord) {
        sharepointHelp.style.display = 'block';
        sharepointHelp.textContent = t('sharepointHelpOneNote');
    } else if (hasWord && !hasOneNote) {
        sharepointHelp.style.display = 'block';
        sharepointHelp.textContent = t('sharepointHelpWord');
    } else if (hasOneNote && hasWord) {
        sharepointHelp.style.display = 'block';
        sharepointHelp.textContent = t('sharepointHelpOneNote') + '\n\n' + t('sharepointHelpWord');
    } else {
        sharepointHelp.style.display = 'none';
    }
    
    // No longer enforce "at least one main preset" - allow using only Hilfsmittel
    // Users can now select only reference tools (e.g., Duden) with a custom start URL
    
    // Update start URL to first selected main preset (if any)
    const firstMainPreset = selectedPresets.find(p => !Object.values(PRESET_GROUPS.allowedTools).flat().includes(p));
    if (firstMainPreset && PRESETS[firstMainPreset]) {
        document.getElementById('startUrl').value = PRESETS[firstMainPreset].startUrl;
    } else if (selectedPresets.length > 0 && !firstMainPreset) {
        // If only Hilfsmittel selected, use first tool's start URL as suggestion
        const firstTool = selectedPresets[0];
        if (PRESETS[firstTool]) {
            document.getElementById('startUrl').value = PRESETS[firstTool].startUrl;
        }
    }
    
    // Update config name
    const mainPresetsForName = selectedPresets.filter(p => !Object.values(PRESET_GROUPS.allowedTools).flat().includes(p));
    const toolPresetsForName = selectedPresets.filter(p => Object.values(PRESET_GROUPS.allowedTools).flat().includes(p));
    
    if (mainPresetsForName.length === 1) {
        const presetName = t('preset' + mainPresetsForName[0].charAt(0).toUpperCase() + mainPresetsForName[0].slice(1));
        document.getElementById('configName').value = `${presetName.replace(/\s+/g, '_')}_Config`;
    } else if (mainPresetsForName.length > 1) {
        document.getElementById('configName').value = `Multi_Service_Config`;
    } else if (toolPresetsForName.length === 1) {
        // Only one Hilfsmittel selected
        const presetName = t('preset' + toolPresetsForName[0].charAt(0).toUpperCase() + toolPresetsForName[0].slice(1));
        document.getElementById('configName').value = `${presetName.replace(/\s+/g, '_')}_Config`;
    } else if (toolPresetsForName.length > 1) {
        document.getElementById('configName').value = `Reference_Tools_Config`;
    } else {
        document.getElementById('configName').value = '';
    }
    
    renderPresets();
    updatePreview();
}

function selectSecurityLevel(key) {
    currentSecurityLevel = key;
    renderSecurityLevels();
}

function updateSecurityLevelWarning() {
    const container = document.getElementById('securityLevel').parentElement;
    let warningDiv = document.getElementById('securityLevelWarning');
    
    // Show warning only for relaxed or strict levels
    const showWarning = currentSecurityLevel === 'relaxed' || currentSecurityLevel === 'strict';
    
    if (showWarning) {
        if (!warningDiv) {
            // Create warning element if it doesn't exist
            warningDiv = document.createElement('div');
            warningDiv.id = 'securityLevelWarning';
            warningDiv.style.cssText = 'background:#fff3cd;border-left:4px solid #ffc107;padding:12px 15px;margin-top:15px;border-radius:4px;color:#856404;font-size:0.9em;';
            
            const warningTitle = document.createElement('strong');
            warningTitle.style.cssText = 'display:block;margin-bottom:6px;';
            warningDiv.appendChild(warningTitle);
            
            const warningText = document.createElement('div');
            warningDiv.appendChild(warningText);
            
            container.appendChild(warningDiv);
        }
        
        // Update content
        const warningTitle = warningDiv.querySelector('strong');
        const warningText = warningDiv.querySelector('div');
        warningTitle.textContent = t('securityLevelExperimentalTitle');
        warningText.textContent = t('securityLevelExperimentalText');
        warningDiv.style.display = 'block';
    } else if (warningDiv) {
        // Hide warning for balanced level
        warningDiv.style.display = 'none';
    }
}

// ============================================================================
// BOOLEAN OPTIONS RENDERING
// ============================================================================
function renderBooleanOptions() {
    const container = document.getElementById('booleanOptionsContainer');
    if (!container) {
        console.error('‚ùå Container not found!');
        return;
    }
    
    console.log('üì¶ Container found, clearing content...');
    container.innerHTML = '';
    
    // Info box
    const infoBox = document.createElement('div');
    infoBox.style.cssText = 'background:#e8f2fa;border-left:4px solid #5b9bd5;padding:12px 15px;margin-bottom:20px;border-radius:4px;color:#2c3e5a;font-size:0.9em;';
    infoBox.innerHTML = `<strong>‚ÑπÔ∏è ${t('allBooleanOptions')}</strong><br>${t('booleanOptionsInfo')}`;
    container.appendChild(infoBox);
    console.log('‚ÑπÔ∏è Info box added');
    
    // Render each group
    const groupOrder = ['browser', 'security', 'interface', 'system', 'network', 'mobile', 'other'];
    console.log('üîç Processing groups:', groupOrder);
    
    groupOrder.forEach(groupKey => {
        const group = parsedBooleanOptions.groups[groupKey];
        console.log(`  - Group ${groupKey}:`, group);
        if (!group || !group.options || group.options.length === 0) {
            console.log(`  ‚ö†Ô∏è Skipping ${groupKey} (no options)`);
            return;
        }
        console.log(`  ‚úÖ Rendering ${groupKey} with ${group.options.length} options`);
        
        // Group container (collapsible)
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'margin-bottom:20px;border:1px solid #dfe6f0;border-radius:8px;overflow:hidden;background:#f5f7fb;';
        
        // Group header (clickable)
        const groupHeader = document.createElement('div');
        groupHeader.style.cssText = 'background:linear-gradient(135deg, #e8edf5 0%, #f5f7fb 100%);padding:12px 15px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;border-bottom:1px solid #dfe6f0;';
        groupHeader.innerHTML = `
            <strong style="color:#2c3e5a;font-size:1em;">${t(group.title)}</strong>
            <span style="color:#6c7a89;font-size:0.9em;">(${group.options.length} ${currentLang === 'de' ? 'Optionen' : 'options'})</span>
        `;
        
        // Options content (initially hidden)
        const groupContent = document.createElement('div');
        groupContent.style.cssText = 'padding:15px;display:none;';
        
        // Toggle functionality
        groupHeader.addEventListener('click', () => {
            const isHidden = groupContent.style.display === 'none';
            groupContent.style.display = isHidden ? 'block' : 'none';
        });
        
        // Render options in grid
        const optionsGrid = document.createElement('div');
        optionsGrid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:12px;';
        
        group.options.forEach(opt => {
            const optionDiv = document.createElement('div');
            optionDiv.style.cssText = 'display:flex;align-items:flex-start;padding:8px;background:#ffffff;border-radius:4px;border:1px solid #dfe6f0;';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `bool_${opt.key}`;
            checkbox.checked = parsedBooleanOptions.userSelections[opt.key];
            checkbox.style.cssText = 'margin-right:8px;margin-top:2px;cursor:pointer;';
            checkbox.addEventListener('change', (e) => {
                parsedBooleanOptions.userSelections[opt.key] = e.target.checked;
            });
            
            const label = document.createElement('label');
            label.htmlFor = `bool_${opt.key}`;
            label.style.cssText = 'cursor:pointer;font-size:0.9em;line-height:1.4;';
            
            const labelText = document.createElement('div');
            labelText.style.cssText = 'color:#2c3e5a;font-weight:500;';
            labelText.textContent = generateOptionLabel(opt.key);
            
            const keyName = document.createElement('div');
            keyName.style.cssText = 'color:#6c7a89;font-size:0.85em;margin-top:2px;font-family:monospace;';
            keyName.textContent = opt.key;
            
            const tooltip = document.createElement('div');
            tooltip.style.cssText = 'color:#8898aa;font-size:0.8em;margin-top:4px;font-style:italic;';
            
            // Get location from JSON (English labels as in original tool)
            const location = getOptionLocation(opt.key);
            if (location) {
                tooltip.textContent = `üìç ${t('sebConfigToolLocation')}: ${location}`;
                tooltip.title = location;
            } else {
                // Use translated hint texts for undocumented options
                const notDocText = getTranslatedText('notDocumented');
                const notDocHint = getTranslatedText('notDocumentedHint');
                tooltip.textContent = `üìç ${t('sebConfigToolLocation')}: ${notDocText}`;
                tooltip.title = notDocHint;
                tooltip.style.opacity = '0.5';
            }
            
            label.appendChild(labelText);
            label.appendChild(keyName);
            label.appendChild(tooltip);
            
            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(label);
            optionsGrid.appendChild(optionDiv);
        });
        
        groupContent.appendChild(optionsGrid);
        groupDiv.appendChild(groupHeader);
        groupDiv.appendChild(groupContent);
        container.appendChild(groupDiv);
    });
}

function getSharePointRestrictionInfo() {
    // Returns information about SharePoint restrictions for display purposes
    // No longer generates URL filter patterns - restrictions are now handled via specific whitelist URLs
    const info = [];
    
    ['onenote', 'word'].forEach(serviceType => {
        const config = sharepointConfig[serviceType];
        if (!config.parsedLink || !config.parsedLink.isSharePoint) return;
        
        const { parsedLink, restrictions } = config;
        
        // Build the replaced and replacement URLs for display
        let genericUrl = `*.sharepoint.com`;
        let specificUrl = `https://${parsedLink.domain}`;
        let restrictionLevel = '';
        let restrictionName = '';
        
        // Determine the most specific restriction level
        if (serviceType === 'onenote') {
            if (restrictions.page && parsedLink.pageId && parsedLink.pageName) {
                specificUrl += `/.../*wd=*${parsedLink.pageId}*`;
                restrictionLevel = currentLang === 'de' ? 'Seite' : 'Page';
                restrictionName = parsedLink.pageName;
            } else if (restrictions.section && parsedLink.sectionId && parsedLink.section) {
                specificUrl += `/.../*${parsedLink.sectionId}*`;
                restrictionLevel = currentLang === 'de' ? 'Abschnitt' : 'Section';
                restrictionName = parsedLink.section;
            } else if (restrictions.notebook && parsedLink.notebook) {
                specificUrl += `/SiteAssets/${parsedLink.notebook}/*`;
                restrictionLevel = currentLang === 'de' ? 'Notizbuch' : 'Notebook';
                restrictionName = parsedLink.notebook;
            } else if (restrictions.teamsSite && parsedLink.teamsSite) {
                specificUrl += `/sites/${parsedLink.teamsSite}/*`;
                restrictionLevel = currentLang === 'de' ? 'Teams-Site' : 'Teams Site';
                restrictionName = parsedLink.teamsSite;
            } else if (restrictions.schoolSharepoint) {
                specificUrl += '/*';
                restrictionLevel = currentLang === 'de' ? 'Schul-SharePoint' : 'School SharePoint';
                restrictionName = parsedLink.domain;
            }
        } else if (serviceType === 'word') {
            if (restrictions.file && parsedLink.fileId && parsedLink.fileName) {
                specificUrl += `/.../*sourcedoc={${parsedLink.fileId}}*`;
                restrictionLevel = currentLang === 'de' ? 'Datei' : 'File';
                restrictionName = parsedLink.fileName;
            } else if (restrictions.folder && parsedLink.folder) {
                specificUrl += `/${parsedLink.folder}/*`;
                restrictionLevel = currentLang === 'de' ? 'Ordner' : 'Folder';
                restrictionName = parsedLink.folder;
            } else if (restrictions.teamsSite && parsedLink.teamsSite) {
                specificUrl += `/sites/${parsedLink.teamsSite}/*`;
                restrictionLevel = currentLang === 'de' ? 'Teams-Site' : 'Teams Site';
                restrictionName = parsedLink.teamsSite;
            } else if (restrictions.schoolSharepoint) {
                specificUrl += '/*';
                restrictionLevel = currentLang === 'de' ? 'Schul-SharePoint' : 'School SharePoint';
                restrictionName = parsedLink.domain;
            }
        }
        
        if (restrictionLevel) {
            info.push({
                genericUrl,
                specificUrl,
                restrictionLevel,
                restrictionName,
                serviceType
            });
        }
    });
    
    return info;
}

// Legacy function name for backwards compatibility - now returns restriction info
function getSharePointUrlPatterns() {
    const patterns = [];
    
    // Check both OneNote and Word configurations
    ['onenote', 'word'].forEach(serviceType => {
        const config = sharepointConfig[serviceType];
        if (!config.parsedLink || !config.parsedLink.isSharePoint) return;
        
        const { parsedLink, restrictions } = config;
        
        // Build URL patterns based on enabled restrictions
        if (restrictions.schoolSharepoint && parsedLink.domain) {
            // Restrict to specific SharePoint domain
            patterns.push({
                expression: `*${parsedLink.domain}*`,
                active: true,
                action: 1, // Allow
                label: currentLang === 'de' ? 'Schul-SharePoint' : 'School SharePoint',
                name: parsedLink.domain || null
            });
        }
        
        if (restrictions.teamsSite && parsedLink.teamsSite) {
            // Restrict to specific Teams site
            patterns.push({
                expression: `*/sites/${parsedLink.teamsSite}/*`,
                active: true,
                action: 1, // Allow
                label: currentLang === 'de' ? 'Teams-Site' : 'Teams Site',
                name: parsedLink.teamsSite || null
            });
        }
        
        if (serviceType === 'onenote') {
            // IMPORTANT: SEB opens OneNote pages via the web URL (_layouts/Doc.aspx?...),
            // NOT via the onenote: protocol URL. Therefore, we must use GUIDs from the
            // web link's wd=target(...) parameter, which contains:
            // - Section GUID (937FFC30-10F8-7546-9E1D-BECCA08633E1)
            // - Page GUID (F07BB273-C7EF-1548-9CFF-A866F644BE47)
            
            // Notebook restriction: Use notebook name in URL path
            // The notebook name appears in the path as /SiteAssets/{NotebookName}/
            if (restrictions.notebook && parsedLink.notebook) {
                patterns.push({
                    expression: `*/SiteAssets/${encodeURIComponent(parsedLink.notebook)}/*`,
                    active: true,
                    action: 1,
                    label: currentLang === 'de' ? 'Notizbuch' : 'Notebook',
                    name: parsedLink.notebook || null
                });
            }
            
            if (restrictions.section && parsedLink.sectionId) {
                // Match section GUID in wd=target(...) parameter
                patterns.push({
                    expression: `*${parsedLink.sectionId}*`,
                    active: true,
                    action: 1,
                    label: currentLang === 'de' ? 'Abschnitt' : 'Section',
                    name: parsedLink.section || null
                });
            }
            
            if (restrictions.page && parsedLink.pageId) {
                // Match page GUID in wd=target(...) parameter
                patterns.push({
                    expression: `*${parsedLink.pageId}*`,
                    active: true,
                    action: 1,
                    label: currentLang === 'de' ? 'Seite' : 'Page',
                    name: parsedLink.pageName || null
                });
            }
        }
        
        if (serviceType === 'word') {
            if (restrictions.folder && parsedLink.folder) {
                patterns.push({
                    expression: `*/${encodeURIComponent(parsedLink.folder)}/*`,
                    active: true,
                    action: 1,
                    label: currentLang === 'de' ? 'Ordner' : 'Folder',
                    name: parsedLink.folder || null
                });
            }
            
            if (restrictions.file && parsedLink.fileId) {
                patterns.push({
                    expression: `*sourcedoc={${parsedLink.fileId}}*`,
                    active: true,
                    action: 1,
                    label: currentLang === 'de' ? 'Datei' : 'File',
                    name: parsedLink.fileName || null
                });
            }
        }
    });
    
    return patterns;
}

function getAllDomains() {
    const MAX_CUSTOM_DOMAINS = 500;  // Limit custom domains to prevent performance issues
    
    // Combine domains from all selected presets
    const presetDomains = [];
    selectedPresets.forEach(presetKey => {
        if (PRESETS[presetKey]) {
            presetDomains.push(...PRESETS[presetKey].domains);
        }
    });
    
    const customDomains = document.getElementById('customDomains').value
        .split('\n')
        .slice(0, MAX_CUSTOM_DOMAINS)  // Limit number of lines
        .map(d => d.trim())
        .filter(d => d && !d.startsWith('#'));
    
    // Check SharePoint restrictions and determine the most restrictive level
    let sharepointRestrictionLevel = 0; // 0=none, 1=school, 2=site, 3=notebook/folder, 4=page/file
    let specificSharePointDomain = null;
    
    ['onenote', 'word'].forEach(serviceType => {
        const config = sharepointConfig[serviceType];
        if (config.parsedLink && config.parsedLink.isSharePoint && config.parsedLink.domain) {
            const r = config.restrictions;
            
            // Determine restriction level (most specific wins)
            // Any restriction implies schoolSharepoint is active
            if (r.page || r.file) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 4);
                specificSharePointDomain = config.parsedLink.domain;
            } else if (r.section || r.notebook || r.folder) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 3);
                specificSharePointDomain = config.parsedLink.domain;
            } else if (r.teamsSite) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 2);
                specificSharePointDomain = config.parsedLink.domain;
            } else if (r.schoolSharepoint) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 1);
                specificSharePointDomain = config.parsedLink.domain;
            }
        }
    });
    
    // Apply domain filtering based on restriction level
    let filteredPresetDomains = presetDomains;
    
    if (sharepointRestrictionLevel >= 1) {
        // Level 1+: Remove SharePoint-related wildcards that would bypass restrictions
        // NOTE: *.sharepointonline.com is removed here - needs integration testing to verify
        // it's not required for 2FA/login. If login issues occur, may need to keep this wildcard.
        const sharePointWildcardsToRemove = [
            '*.sharepoint.com',
            '*.sharepointonline.com'  // TODO: Verify not needed for 2FA during integration tests
        ];
        
        filteredPresetDomains = filteredPresetDomains.filter(d => 
            !sharePointWildcardsToRemove.includes(d.toLowerCase())
        );
        
        if (sharepointRestrictionLevel >= 2) {
            // Level 2+: Also remove any tenant-specific wildcards (e.g., *.kshch0.sharepoint.com)
            filteredPresetDomains = filteredPresetDomains.filter(d => {
                const lowerD = d.toLowerCase();
                // Remove anything that starts with *. and contains sharepoint
                return !(lowerD.startsWith('*.') && (lowerD.includes('.sharepoint.com') || lowerD.includes('.sharepointonline.com')));
            });
        }
        
        // Add back specific SharePoint URLs based on restriction level
        // The more specific the restriction, the more specific the URL
        if (sharepointRestrictionLevel >= 1) {
            ['onenote', 'word'].forEach(serviceType => {
                const config = sharepointConfig[serviceType];
                if (!config.parsedLink || !config.parsedLink.isSharePoint) return;
                
                const { parsedLink, restrictions } = config;
                
                // Build the specific URL based on the most restrictive level
                let specificUrl = `https://${parsedLink.domain}`;
                
                // Add Teams site if available
                if (parsedLink.teamsSite && (restrictions.teamsSite || restrictions.notebook || restrictions.section || restrictions.page || restrictions.folder || restrictions.file)) {
                    specificUrl += `/sites/${parsedLink.teamsSite}`;
                }
                
                if (serviceType === 'onenote') {
                    if (restrictions.page && parsedLink.pageId) {
                        // Most specific: Page level - use full _layouts URL with page ID
                        // This allows only this specific page
                        specificUrl += `/*wd=*${parsedLink.pageId}*`;
                    } else if (restrictions.section && parsedLink.sectionId) {
                        // Section level - use section ID in URL
                        specificUrl += `/*${parsedLink.sectionId}*`;
                    } else if (restrictions.notebook && parsedLink.notebook) {
                        // Notebook level - use SiteAssets path
                        specificUrl += `/SiteAssets/${encodeURIComponent(parsedLink.notebook)}/*`;
                    } else {
                        // School or Teams site level only
                        specificUrl += '/*';
                    }
                } else if (serviceType === 'word') {
                    if (restrictions.file && parsedLink.fileId) {
                        // File level - use sourcedoc parameter
                        specificUrl += `/*sourcedoc={${parsedLink.fileId}}*`;
                    } else if (restrictions.folder && parsedLink.folder) {
                        // Folder level
                        specificUrl += `/${encodeURIComponent(parsedLink.folder)}/*`;
                    } else {
                        // School or Teams site level only
                        specificUrl += '/*';
                    }
                }
                
                filteredPresetDomains.push(specificUrl);
            });
        }
    }
    
    // Combine and remove duplicates (case-insensitive)
    const allDomains = [...filteredPresetDomains, ...customDomains];
    const uniqueDomains = [];
    const seen = new Set();
    
    allDomains.forEach(domain => {
        const lowerDomain = domain.toLowerCase();
        if (!seen.has(lowerDomain)) {
            seen.add(lowerDomain);
            uniqueDomains.push(domain);
        }
    });
    
    return uniqueDomains;
}

function updatePreview() {
    const presetDomains = [];
    selectedPresets.forEach(presetKey => {
        if (PRESETS[presetKey]) {
            presetDomains.push(...PRESETS[presetKey].domains);
        }
    });
    
    const customDomains = document.getElementById('customDomains').value
        .split('\n')
        .map(d => d.trim())
        .filter(d => d && !d.startsWith('#'));
    
    const allDomainsBeforeDedup = [...presetDomains, ...customDomains];
    const domains = getAllDomains();
    const duplicatesRemoved = allDomainsBeforeDedup.length - domains.length;
    
    const container = document.getElementById('domainPreview');
    document.getElementById('domainCount').textContent = domains.length;
    
    // Clear container safely
    container.innerHTML = '';
    
    // Show warning if duplicates were removed (add first)
    if (duplicatesRemoved > 0) {
        const warningDiv = document.createElement('div');
        warningDiv.style.cssText = 'background:#fff3cd;border-left:4px solid #ffc107;padding:10px;margin-bottom:10px;border-radius:4px;color:#856404;font-size:0.9em;';
        const warningText = currentLang === 'de' 
            ? `‚ö†Ô∏è ${duplicatesRemoved} doppelte Domain(s) wurden entfernt`
            : `‚ö†Ô∏è ${duplicatesRemoved} duplicate domain(s) removed`;
        warningDiv.textContent = warningText;
        container.appendChild(warningDiv);
    }
    
    // Show SharePoint restriction info if active
    let sharepointRestrictionLevel = 0;
    let specificSharePointDomain = null;
    let restrictionLabels = [];
    
    ['onenote', 'word'].forEach(serviceType => {
        const config = sharepointConfig[serviceType];
        if (config.parsedLink && config.parsedLink.isSharePoint && config.parsedLink.domain) {
            const r = config.restrictions;
            
            // Determine level first
            if (r.page || r.file) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 4);
            } else if (r.section || r.notebook || r.folder) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 3);
            } else if (r.teamsSite) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 2);
            } else if (r.schoolSharepoint) {
                sharepointRestrictionLevel = Math.max(sharepointRestrictionLevel, 1);
            }
            
            // Build hierarchical label list (all parent levels are implicitly active)
            if (sharepointRestrictionLevel >= 1) {
                specificSharePointDomain = config.parsedLink.domain;
                restrictionLabels.push(currentLang === 'de' ? 'Schul-SharePoint' : 'School SharePoint');
            }
            if (sharepointRestrictionLevel >= 2 && r.teamsSite) {
                restrictionLabels.push(currentLang === 'de' ? 'Teams-Site' : 'Teams Site');
            }
            if (sharepointRestrictionLevel >= 3) {
                if (r.notebook) {
                    restrictionLabels.push(currentLang === 'de' ? 'Notizbuch' : 'Notebook');
                }
                if (r.section) {
                    restrictionLabels.push(currentLang === 'de' ? 'Abschnitt' : 'Section');
                }
                if (r.folder) {
                    restrictionLabels.push(currentLang === 'de' ? 'Ordner' : 'Folder');
                }
            }
            if (sharepointRestrictionLevel >= 4) {
                if (r.page) {
                    restrictionLabels.push(currentLang === 'de' ? 'Seite' : 'Page');
                }
                if (r.file) {
                    restrictionLabels.push(currentLang === 'de' ? 'Datei' : 'File');
                }
            }
        }
    });
    
    if (sharepointRestrictionLevel > 0 && restrictionLabels.length > 0) {
        const spInfoDiv = document.createElement('div');
        spInfoDiv.style.cssText = 'background:#d1ecf1;border-left:4px solid #17a2b8;padding:10px;margin-bottom:10px;border-radius:4px;color:#0c5460;font-size:0.9em;';
        
        let spInfoText = '';
        if (sharepointRestrictionLevel === 1) {
            spInfoText = currentLang === 'de'
                ? `üîí SharePoint: *.sharepoint.com ‚Üí ${specificSharePointDomain}`
                : `üîí SharePoint: *.sharepoint.com ‚Üí ${specificSharePointDomain}`;
        } else if (sharepointRestrictionLevel >= 2) {
            const restrictionText = restrictionLabels.join(' ‚Üí ');
            spInfoText = currentLang === 'de'
                ? `üîí Einschr√§nkungen: ${restrictionText} (Wildcards entfernt)`
                : `üîí Restrictions: ${restrictionText} (wildcards removed)`;
        }
        
        spInfoDiv.textContent = spInfoText;
        container.appendChild(spInfoDiv);
    }
    
    // Show selected services/tools info
    if (selectedPresets.length > 0) {
        const serviceNames = selectedPresets.map(key => 
            t('preset' + key.charAt(0).toUpperCase() + key.slice(1))
        ).join(', ');
        const infoDiv = document.createElement('div');
        infoDiv.style.cssText = 'background:#d4edda;border-left:4px solid #28a745;padding:10px;margin-bottom:10px;border-radius:4px;color:#155724;font-size:0.9em;';
        const infoText = currentLang === 'de'
            ? `‚úì Ausgew√§hlt: ${serviceNames}`
            : `‚úì Selected: ${serviceNames}`;
        infoDiv.textContent = infoText;
        container.appendChild(infoDiv);
    } else if (customDomains.length > 0) {
        // Show info when only custom domains are used
        const infoDiv = document.createElement('div');
        infoDiv.style.cssText = 'background:#d1ecf1;border-left:4px solid #17a2b8;padding:10px;margin-bottom:10px;border-radius:4px;color:#0c5460;font-size:0.9em;';
        const infoText = currentLang === 'de'
            ? `‚ÑπÔ∏è Nur benutzerdefinierte Domains`
            : `‚ÑπÔ∏è Custom domains only`;
        infoDiv.textContent = infoText;
        container.appendChild(infoDiv);
    }
    
    // Add allowed domains (XSS-safe with textContent)
    domains.forEach(domain => {
        const div = document.createElement('div');
        div.className = 'domain-item';
        div.textContent = `‚úì ${domain}`;
        container.appendChild(div);
    });
    
    // Show SharePoint restriction info box if active
    const restrictionInfo = getSharePointRestrictionInfo();
    
    if (restrictionInfo.length > 0) {
        const restrictionSectionDiv = document.createElement('div');
        restrictionSectionDiv.style.cssText = 'margin-top:20px;padding:15px;background:#e7f3ff;border-left:4px solid #17a2b8;border-radius:4px;';
        
        const restrictionTitleStrong = document.createElement('strong');
        restrictionTitleStrong.style.cssText = 'color:#2c3e5a;display:block;margin-bottom:10px;font-size:1em;';
        const restrictionTitle = currentLang === 'de' 
            ? 'üîó SharePoint-Einschr√§nkungen (Spezifisch ersetzt Generisch)'
            : 'üîó SharePoint Restrictions (Specific Replaces Generic)';
        restrictionTitleStrong.textContent = restrictionTitle;
        restrictionSectionDiv.appendChild(restrictionTitleStrong);
        
        const restrictionExplain = document.createElement('div');
        restrictionExplain.style.cssText = 'font-size:0.85em;color:#0c5460;margin-bottom:15px;font-style:italic;';
        const explainText = currentLang === 'de'
            ? 'Generische Wildcards werden durch spezifische URLs ersetzt. Andere Domains (Login, 2FA etc.) bleiben unber√ºhrt:'
            : 'Generic wildcards are replaced by specific URLs. Other domains (login, 2FA etc.) remain unaffected:';
        restrictionExplain.textContent = explainText;
        restrictionSectionDiv.appendChild(restrictionExplain);
        
        // Display each restriction replacement
        restrictionInfo.forEach(info => {
            const replacementDiv = document.createElement('div');
            replacementDiv.style.cssText = 'padding:12px;margin:10px 0;background:#fff;border-radius:4px;border:1px solid #bee5eb;';
            
            // Show restriction level and name
            const levelDiv = document.createElement('div');
            levelDiv.style.cssText = 'font-weight:600;color:#17a2b8;margin-bottom:8px;font-size:0.95em;';
            levelDiv.textContent = `${info.restrictionLevel}: ${info.restrictionName}`;
            replacementDiv.appendChild(levelDiv);
            
            // Show generic URL (crossed out)
            const genericDiv = document.createElement('div');
            genericDiv.style.cssText = 'font-family:monospace;font-size:0.85em;color:#999;text-decoration:line-through;margin-bottom:4px;';
            genericDiv.textContent = `‚ùå ${info.genericUrl}`;
            replacementDiv.appendChild(genericDiv);
            
            // Show arrow
            const arrowDiv = document.createElement('div');
            arrowDiv.style.cssText = 'color:#17a2b8;margin:4px 0;font-size:1.2em;';
            arrowDiv.textContent = '‚¨áÔ∏è';
            replacementDiv.appendChild(arrowDiv);
            
            // Show specific URL (highlighted)
            const specificDiv = document.createElement('div');
            specificDiv.style.cssText = 'font-family:monospace;font-size:0.85em;color:#0c5460;font-weight:600;margin-top:4px;word-break:break-all;';
            specificDiv.textContent = `‚úÖ ${info.specificUrl}`;
            replacementDiv.appendChild(specificDiv);
            
            restrictionSectionDiv.appendChild(replacementDiv);
        });
        
        container.appendChild(restrictionSectionDiv);
    }
    
    // Show blocked domains if any
    const blockedDomains = [];
    selectedPresets.forEach(presetKey => {
        const preset = PRESETS[presetKey];
        if (preset && preset.blockedDomains) {
            blockedDomains.push(...preset.blockedDomains);
        }
    });
    
    // Add custom blocked domains from user input
    const MAX_BLOCKED_DOMAINS = 500;  // Limit blocked domains to prevent performance issues
    const customBlockedInput = document.getElementById('blockedDomains').value;
    if (customBlockedInput.trim()) {
        const customBlockedDomains = customBlockedInput
            .split('\n')
            .slice(0, MAX_BLOCKED_DOMAINS)  // Limit number of lines
            .map(domain => domain.trim())
            .filter(domain => domain && !domain.startsWith('#'));
        blockedDomains.push(...customBlockedDomains);
    }
    
    if (blockedDomains.length > 0) {
        const blockedTitleDiv = document.createElement('div');
        blockedTitleDiv.style.cssText = 'margin-top:20px;padding-top:15px;border-top:2px solid #dfe6f0;';
        const blockedTitleStrong = document.createElement('strong');
        blockedTitleStrong.style.color = '#2c3e5a';
        const blockedTitle = currentLang === 'de' 
            ? 'üö´ Blockierte Domains (explizit gesperrt)'
            : 'üö´ Blocked Domains (explicitly denied)';
        blockedTitleStrong.textContent = blockedTitle;
        blockedTitleDiv.appendChild(blockedTitleStrong);
        container.appendChild(blockedTitleDiv);
        
        // Add blocked domains (XSS-safe with textContent)
        blockedDomains.forEach(domain => {
            const div = document.createElement('div');
            div.className = 'domain-item';
            div.style.color = '#dc3545';
            div.textContent = `‚úó ${domain}`;
            container.appendChild(div);
        });
    }
}

// ============================================================================
// CONFIG GENERATION - XML (PLIST)
// ============================================================================
function generateConfigXML() {
    const securitySettings = SECURITY_LEVELS[currentSecurityLevel].settings;
    const domains = getAllDomains();
    const startUrlInput = document.getElementById('startUrl').value;
    
    // Validate start URL
    if (!isValidURL(startUrlInput)) {
        const errorMsg = currentLang === 'de'
            ? 'Ung√ºltige Start-URL. Bitte geben Sie eine g√ºltige http:// oder https:// URL ein.'
            : 'Invalid start URL. Please enter a valid http:// or https:// URL.';
        alert(errorMsg);
        return null;
    }
    
    const startUrl = startUrlInput;
    
    // Build URL filter rules XML (whitelist - action: 1)
    let urlFilterRulesXML = '';
    domains.forEach(domain => {
        urlFilterRulesXML += `\t\t<dict>
\t\t\t<key>action</key>
\t\t\t<integer>1</integer>
\t\t\t<key>active</key>
\t\t\t<true/>
\t\t\t<key>expression</key>
\t\t\t<string>${escapeXML(domain)}</string>
\t\t\t<key>regex</key>
\t\t\t<false/>
\t\t</dict>
`;
    });
    
    // NOTE: SharePoint restrictions are now handled via specific URLs in the whitelist above
    // No separate URL filter patterns needed - this prevents conflicts with login/2FA domains
    
    // Add blocked domains (blacklist - action: 0) from selected presets
    selectedPresets.forEach(presetKey => {
        const preset = PRESETS[presetKey];
        if (preset && preset.blockedDomains) {
            preset.blockedDomains.forEach(domain => {
                urlFilterRulesXML += `\t\t<dict>
\t\t\t<key>action</key>
\t\t\t<integer>0</integer>
\t\t\t<key>active</key>
\t\t\t<true/>
\t\t\t<key>expression</key>
\t\t\t<string>${escapeXML(domain)}</string>
\t\t\t<key>regex</key>
\t\t\t<false/>
\t\t</dict>
`;
            });
        }
    });
    
    // Add custom blocked domains (blacklist - action: 0) from user input
    const customBlockedInput = document.getElementById('blockedDomains').value;
    if (customBlockedInput.trim()) {
        const MAX_BLOCKED_DOMAINS = 500;  // Limit blocked domains to prevent performance issues
        const customBlockedDomains = customBlockedInput
            .split('\n')
            .slice(0, MAX_BLOCKED_DOMAINS)  // Limit number of lines
            .map(domain => domain.trim())
            .filter(domain => domain && !domain.startsWith('#'));
        
        customBlockedDomains.forEach(domain => {
            urlFilterRulesXML += `\t\t<dict>
\t\t\t<key>action</key>
\t\t\t<integer>0</integer>
\t\t\t<key>active</key>
\t\t\t<true/>
\t\t\t<key>expression</key>
\t\t\t<string>${escapeXML(domain)}</string>
\t\t\t<key>regex</key>
\t\t\t<false/>
\t\t</dict>
`;
        });
    }
    
    // Generate complete plist XML with version info
    const buildDateFormatted = formatBuildDate('en'); // Use international format for file
    const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<!-- Generated by SEB Config Generator ${APP_VERSION} (Build: ${buildDateFormatted}) -->
<!-- https://github.com/markuskiller/SEBConfigGenerator -->
<plist version="1.0">
<dict>
\t<key>URLFilterEnable</key>
\t<${urlFilterRulesXML.length > 0 ? 'true' : 'false'}/>
\t<key>URLFilterEnableContentFilter</key>
\t<false/>
\t<key>URLFilterRules</key>
\t<array>
${urlFilterRulesXML}\t</array>
\t<key>allowAudioCapture</key>
\t<false/>
\t<key>allowBrowsingBackForward</key>
\t<${document.getElementById('allowBackForward').checked ? 'true' : 'false'}/>
\t<key>allowDictionaryLookup</key>
\t<false/>
\t<key>allowDownUploads</key>
\t<${document.getElementById('allowDownloads').checked ? 'true' : 'false'}/>
\t<key>allowDownloads</key>
\t<${document.getElementById('allowDownloads').checked ? 'true' : 'false'}/>
\t<key>allowFlashFullscreen</key>
\t<false/>
\t<key>allowPreferencesWindow</key>
\t<false/>
\t<key>allowQuit</key>
\t<${securitySettings.allowQuit ? 'true' : 'false'}/>
\t<key>allowSpellCheck</key>
\t<${document.getElementById('allowSpellCheck').checked ? 'true' : 'false'}/>
\t<key>allowSwitchToApplications</key>
\t<${securitySettings.allowSwitchToApplications ? 'true' : 'false'}/>
\t<key>allowVideoCapture</key>
\t<false/>
\t<key>browserViewMode</key>
\t<integer>${securitySettings.browserViewMode}</integer>
\t<key>browserWindowAllowReload</key>
\t<${document.getElementById('showReloadButton').checked ? 'true' : 'false'}/>
\t<key>enableBrowserWindowToolbar</key>
\t<${securitySettings.enableBrowserWindowToolbar ? 'true' : 'false'}/>
\t<key>enablePlugIns</key>
\t<true/>
\t<key>enableSebBrowser</key>
\t<true/>
\t<key>enableZoomPage</key>
\t<true/>
\t<key>enableZoomText</key>
\t<true/>
\t<key>examSessionClearCookiesOnEnd</key>
\t<true/>
\t<key>examSessionClearCookiesOnStart</key>
\t<true/>
\t<key>newBrowserWindowAllowReload</key>
\t<${document.getElementById('showReloadButton').checked ? 'true' : 'false'}/>
\t<key>originatorVersion</key>
\t<string>SEB_Config_Generator_${APP_VERSION}_${buildDateFormatted.replace(/[/:]/g, '-').replace(/ /g, '_')}</string>
\t<key>removeBrowserProfile</key>
\t<false/>
\t<key>showMenuBar</key>
\t<${securitySettings.showMenuBar ? 'true' : 'false'}/>
\t<key>showReloadButton</key>
\t<${document.getElementById('showReloadButton').checked ? 'true' : 'false'}/>
\t<key>startURL</key>
\t<string>${escapeXML(startUrl)}</string>
\t<key>touchOptimized</key>
\t<false/>`;
    
    // Add all boolean options from parsed XML (dynamically loaded)
    // This includes ALL true/false options that were parsed from the template
    let booleanOptionsXML = '';
    if (parsedBooleanOptions.options && Object.keys(parsedBooleanOptions.options).length > 0) {
        // Sort keys alphabetically for consistent output
        const sortedKeys = Object.keys(parsedBooleanOptions.userSelections).sort();
        sortedKeys.forEach(key => {
            const value = parsedBooleanOptions.userSelections[key];
            booleanOptionsXML += `\n\t<key>${escapeXML(key)}</key>\n\t<${value ? 'true' : 'false'}/>`;
        });
    }
    
    const finalXML = xml + booleanOptionsXML + `
</dict>
</plist>`;
    
    return finalXML;
}

function escapeXML(str) {
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
}

function sanitizeFilename(filename) {
    // Remove potentially dangerous characters, allow only safe ones
    // Uses Unicode property escapes to support all language characters (French, German, Italian, Spanish, etc.)
    return filename
        .replace(/[^\p{L}\p{N}_\-]/gu, '_')  // Allow Unicode letters, numbers, underscore, dash
        .replace(/_{2,}/g, '_')  // Replace multiple underscores with single one
        .replace(/^_+|_+$/g, '')  // Remove leading/trailing underscores
        .substring(0, 100)  // Limit length to 100 characters
        || 'SEB_Config';  // Fallback if empty after sanitization
}

function isValidURL(url) {
    // Validate URL format and protocol
    if (!url || !url.trim()) {
        return false;
    }
    try {
        const parsed = new URL(url);
        // Only allow http and https protocols
        return ['http:', 'https:'].includes(parsed.protocol);
    } catch {
        return false;
    }
}

function downloadConfig() {
    const configXML = generateConfigXML();
    
    // Check if validation failed
    if (!configXML) {
        return;
    }
    
    const rawConfigName = document.getElementById('configName').value || 'SEB_Config';
    const configName = sanitizeFilename(rawConfigName);
    const blob = new Blob([configXML], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${configName}.seb`;
    a.click();
    URL.revokeObjectURL(url);
}

function copyDomains() {
    const domains = getAllDomains().join('\n');
    navigator.clipboard.writeText(domains).then(() => {
        const btn = document.getElementById('copyBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = t('copiedMsg');
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    });
}

// ============================================================================
// BROWSER HELPER FUNCTIONALITY
// ============================================================================
function showBrowserHelper() {
    // Get current preset domains for filtering
    const presetDomains = [];
    selectedPresets.forEach(presetKey => {
        if (PRESETS[presetKey]) {
            presetDomains.push(...PRESETS[presetKey].domains);
        }
    });
    const presetDomainsJSON = JSON.stringify([...new Set(presetDomains)]);
    
    const script = `// SEB Domain Capture Script - Run AFTER fully logging in and using the service
(function() {
    console.clear();
    console.log('%cüõ°Ô∏è SEB Domain Capture', 'font-size:20px; color:#5e72e4; font-weight:bold;');
    console.log('%c' + '='.repeat(60), 'color:#ccc;');
    
    // Preset domains from current configuration
    const presetDomains = ${presetDomainsJSON};
    const presetSet = new Set(presetDomains.map(d => d.toLowerCase()));
    
    const allDomains = new Set();
    
    // Capture all network requests
    performance.getEntries().forEach(entry => {
        try {
            const url = new URL(entry.name);
            if (url.hostname && !url.hostname.match(/^(localhost|127\\\\.0\\\\.0\\\\.1|::1)$/)) {
                allDomains.add(url.hostname.toLowerCase());
            }
        } catch (e) {}
    });
    
    // Filter out domains already in preset
    const newDomains = [...allDomains].filter(domain => {
        // Check exact match
        if (presetSet.has(domain)) return false;
        
        // Check if domain matches any preset wildcard
        for (let preset of presetDomains) {
            if (preset.startsWith('*.')) {
                const suffix = preset.substring(1); // Remove *
                if (domain.endsWith(suffix) || domain === suffix.substring(1)) {
                    return false;
                }
            }
        }
        return true;
    }).sort();
    
    console.log(\`\\nüìä Total captured: \${allDomains.size} domains\`);
    console.log(\`‚úì Already in preset: \${allDomains.size - newDomains.length} domains\`);
    console.log(\`üÜï New domains found: \${newDomains.length} domains\\n\`);
    
    if (newDomains.length === 0) {
        console.log('%c‚úÖ NO NEW DOMAINS NEEDED!', 'color:#2dce89; font-size:18px; font-weight:bold;');
        console.log('%cAll captured domains are already in the preset.', 'color:#666;');
        console.log('\\n' + '='.repeat(60) + '\\n');
        return;
    }
    
    // Generate wildcards for new domains only
    const wildcards = new Set();
    newDomains.forEach(domain => {
        const parts = domain.split('.');
        if (parts.length > 2) {
            wildcards.add('*.' + parts.slice(-2).join('.'));
        } else {
            wildcards.add(domain);
        }
    });
    
    const output = [...wildcards].sort().join('\\n');
    
    console.log('='.repeat(60));
    console.log('%cüìã COPY THESE NEW DOMAINS:', 'color:#f5365c; font-size:16px; font-weight:bold;');
    console.log('='.repeat(60) + '\\n');
    console.log(output);
    console.log('\\n' + '='.repeat(60));
    
    console.log('\\n%cüìù HOW TO USE:', 'color:#5e72e4; font-weight:bold;');
    console.log('  1. Select the domain list above (click & drag)');
    console.log('  2. Right-click ‚Üí Copy (or Ctrl+C / Cmd+C)');
    console.log('  3. Paste into "Custom Domains" field in SEB Generator');
    console.log('\\n' + '='.repeat(60) + '\\n');
})();`;

    const bookmarklet = `javascript:(function(){const domains=new Set();performance.getEntries().forEach(e=>{try{const u=new URL(e.name);if(u.hostname&&!u.hostname.match(/^(localhost|127\\\\.0\\\\.0\\\\.1|::1)$/)){domains.add(u.hostname)}}catch(err){}});const sorted=[...domains].sort();let output='SEB Domain Capture\\n'+'='.repeat(50)+'\\n\\n';output+='Total domains: '+sorted.length+'\\n\\n';output+='DOMAINS:\\n'+'-'.repeat(50)+'\\n';output+=sorted.join('\\n')+'\\n';output+='-'.repeat(50)+'\\n\\n';output+='Wildcards (recommended):\\n'+'-'.repeat(50)+'\\n';const wildcards=new Set();sorted.forEach(d=>{const parts=d.split('.');if(parts.length>2){wildcards.add('*.'+parts.slice(-2).join('.'))}else{wildcards.add(d)}});output+=[...wildcards].sort().join('\\n');const modal=document.createElement('div');modal.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:999999;max-width:600px;max-height:80vh;overflow:auto;font-family:monospace;';const pre=document.createElement('pre');pre.textContent=output;pre.style.cssText='background:#f5f5f5;padding:15px;border-radius:6px;overflow:auto;max-height:400px;font-size:12px;';const btnContainer=document.createElement('div');btnContainer.style.cssText='margin-top:20px;display:flex;gap:10px;';const copyBtn=document.createElement('button');copyBtn.textContent='üìã Copy';copyBtn.style.cssText='padding:12px 20px;background:#5e72e4;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;flex:1;';copyBtn.onclick=()=>{navigator.clipboard.writeText(sorted.join('\\n')).then(()=>{copyBtn.textContent='‚úì Copied!';setTimeout(()=>copyBtn.textContent='üìã Copy',2000)})};const closeBtn=document.createElement('button');closeBtn.textContent='‚úï';closeBtn.style.cssText='padding:12px 20px;background:#e9ecef;color:#32325d;border:none;border-radius:6px;cursor:pointer;font-weight:600;';closeBtn.onclick=()=>modal.remove();btnContainer.appendChild(copyBtn);btnContainer.appendChild(closeBtn);modal.appendChild(pre);modal.appendChild(btnContainer);document.body.appendChild(modal)})();`;

    const instructions = currentLang === 'de' 
        ? {
            title: 'üåê Browser-basierte Domain-Erfassung',
            method1: 'Methode 1: Console Script (Empfohlen)',
            method1Steps: [
                '‚ö†Ô∏è WICHTIG: Zuerst Browser-Cache leeren (Strg+Shift+Entf / Cmd+Shift+Entf)',
                '1. √ñffnen Sie den Dienst (z.B. OneNote) in einem neuen Tab',
                '2. Nutzen Sie den Dienst vollst√§ndig (einloggen, arbeiten)',
                '3. Dr√ºcken Sie F12 um DevTools zu √∂ffnen',
                '4. Gehen Sie zum Tab "Konsole"',
                '5. Kopieren Sie das Skript unten und f√ºgen Sie es ein',
                '6. Dr√ºcken Sie Enter',
                '7. Zeigt nur NEUE Domains (nicht bereits in Preset)',
                '8. W√§hlen Sie die Domains aus und kopieren Sie sie manuell',
                '9. F√ºgen Sie sie ins Feld "Benutzerdefinierte Domains" ein'
            ],
            method2: 'Methode 2: Bookmarklet',
            method2Steps: [
                '1. Erstellen Sie ein neues Lesezeichen',
                '2. Kopieren Sie den Bookmarklet-Code unten',
                '3. F√ºgen Sie ihn als URL des Lesezeichens ein',
                '4. √ñffnen Sie Ihren Dienst und klicken Sie das Lesezeichen',
                '5. Ein Dialog zeigt alle Domains'
            ],
            consoleLabel: 'Console Script:',
            bookmarkletLabel: 'Bookmarklet Code:',
            copyScript: 'üìã Script kopieren',
            copyBookmarklet: 'üìã Bookmarklet kopieren',
            fullGuide: 'üìñ Vollst√§ndige Anleitung',
            close: 'Schlie√üen'
        }
        : {
            title: 'üåê Browser-Based Domain Capture',
            method1: 'Method 1: Console Script (Recommended)',
            method1Steps: [
                '‚ö†Ô∏è IMPORTANT: First clear browser cache (Ctrl+Shift+Delete / Cmd+Shift+Delete)',
                '1. Open your service (e.g., OneNote) in a new tab',
                '2. Use the service fully (login, work normally)',
                '3. Press F12 to open DevTools',
                '4. Go to the "Console" tab',
                '5. Copy the script below and paste it',
                '6. Press Enter',
                '7. Shows only NEW domains (not already in preset)',
                '8. Select the domains and copy them manually',
                '9. Paste them into the "Custom Domains" field'
            ],
            method2: 'Method 2: Bookmarklet',
            method2Steps: [
                '1. Create a new bookmark',
                '2. Copy the bookmarklet code below',
                '3. Paste it as the bookmark URL',
                '4. Open your service and click the bookmark',
                '5. A dialog will show all domains'
            ],
            consoleLabel: 'Console Script:',
            bookmarkletLabel: 'Bookmarklet Code:',
            copyScript: 'üìã Copy Script',
            copyBookmarklet: 'üìã Copy Bookmarklet',
            fullGuide: 'üìñ Full Guide',
            close: 'Close'
        };

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
    
    const content = document.createElement('div');
    content.style.cssText = 'background:white;border-radius:12px;padding:30px;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);';
    
    content.innerHTML = `
        <h2 style="color:#5e72e4;margin-bottom:20px;">${instructions.title}</h2>
        
        <div style="background:#f0f3ff;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="color:#5e72e4;margin-bottom:15px;">${instructions.method1}</h3>
            ${instructions.method1Steps.map(step => `<div style="margin:8px 0;">${step}</div>`).join('')}
            
            <div style="margin-top:15px;">
                <label style="font-weight:600;color:#32325d;display:block;margin-bottom:8px;">${instructions.consoleLabel}</label>
                <textarea readonly style="width:100%;height:120px;font-family:monospace;font-size:12px;padding:10px;border:2px solid #e9ecef;border-radius:6px;resize:vertical;">${script}</textarea>
                <button id="copyScriptBtn" style="margin-top:10px;padding:10px 20px;background:#5e72e4;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">${instructions.copyScript}</button>
            </div>
        </div>
        
        <div style="background:#f7f8fc;padding:20px;border-radius:8px;margin-bottom:20px;">
            <h3 style="color:#5e72e4;margin-bottom:15px;">${instructions.method2}</h3>
            ${instructions.method2Steps.map(step => `<div style="margin:8px 0;">${step}</div>`).join('')}
            
            <div style="margin-top:15px;">
                <label style="font-weight:600;color:#32325d;display:block;margin-bottom:8px;">${instructions.bookmarkletLabel}</label>
                <textarea readonly style="width:100%;height:100px;font-family:monospace;font-size:11px;padding:10px;border:2px solid #e9ecef;border-radius:6px;resize:vertical;">${bookmarklet}</textarea>
                <button id="copyBookmarkletBtn" style="margin-top:10px;padding:10px 20px;background:#5e72e4;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">${instructions.copyBookmarklet}</button>
            </div>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:space-between;margin-top:20px;">
            <a href="https://github.com/markuskiller/SEBConfigGenerator/blob/main/docs/${currentLang}/BROWSER_CAPTURE_${currentLang === 'de' ? 'ANLEITUNG' : 'GUIDE'}.md" target="_blank" rel="noopener noreferrer" style="padding:12px 24px;background:#f7f8fc;color:#5e72e4;border:2px solid #e9ecef;border-radius:6px;text-decoration:none;font-weight:600;">${instructions.fullGuide}</a>
            <button id="closeBrowserHelperBtn" style="padding:12px 24px;background:#e9ecef;color:#32325d;border:none;border-radius:6px;cursor:pointer;font-weight:600;">${instructions.close}</button>
        </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // Event listeners
    document.getElementById('copyScriptBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(script);
        const btn = document.getElementById('copyScriptBtn');
        const original = btn.textContent;
        btn.textContent = '‚úì ' + (currentLang === 'de' ? 'Kopiert!' : 'Copied!');
        setTimeout(() => btn.textContent = original, 2000);
    });
    
    document.getElementById('copyBookmarkletBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(bookmarklet);
        const btn = document.getElementById('copyBookmarkletBtn');
        const original = btn.textContent;
        btn.textContent = '‚úì ' + (currentLang === 'de' ? 'Kopiert!' : 'Copied!');
        setTimeout(() => btn.textContent = original, 2000);
    });
    
    document.getElementById('closeBrowserHelperBtn').addEventListener('click', () => {
        modal.remove();
    });
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================
function attachEventListeners() {
    // Language toggle
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });
    
    // Main actions
    document.getElementById('generateBtn').addEventListener('click', downloadConfig);
    document.getElementById('copyBtn').addEventListener('click', copyDomains);
    document.getElementById('customDomains').addEventListener('input', updatePreview);
    document.getElementById('blockedDomains').addEventListener('input', updatePreview);
    document.getElementById('startUrl').addEventListener('input', updatePreview);
    
    // SharePoint link parsing
    document.getElementById('sharepointLink').addEventListener('input', function() {
        const url = this.value.trim();
        if (!url) {
            document.getElementById('sharepointOptions').style.display = 'none';
            return;
        }
        
        // Determine which service type is selected
        let serviceType = null;
        if (selectedPresets.includes('onenote')) {
            serviceType = 'onenote';
        } else if (selectedPresets.includes('word')) {
            serviceType = 'word';
        }
        
        if (serviceType) {
            const parsed = parseSharePointLink(url, serviceType);
            sharepointConfig[serviceType].parsedLink = parsed;
            renderSharePointOptions(serviceType, parsed);
        }
    });
    
    // Browser helper
    document.getElementById('browserHelperBtn').addEventListener('click', showBrowserHelper);
    
    // Advanced section toggle
    document.getElementById('advancedHeader').addEventListener('click', toggleAdvancedSection);
}

// ============================================================================
// ADVANCED SECTION TOGGLE
// ============================================================================
async function toggleAdvancedSection() {
    const content = document.getElementById('advancedContent');
    const toggle = document.querySelector('.advanced-toggle');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggle.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        toggle.classList.add('expanded');
        
        // Lazy load boolean options on first expand
        if (!parsedBooleanOptions.loaded) {
            const container = document.getElementById('booleanOptionsContainer');
            if (container && container.children.length === 0) {
                // Show loading indicator
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#6c7a89;">‚è≥ ' + 
                    (currentLang === 'de' ? 'Lade Optionen...' : 'Loading options...') + '</div>';
                
                // Load boolean options locations from JSON and parse options from XML template
                console.log('üîÑ Starting to load boolean options...');
                
                // Load locations for current platform (in parallel with XML parsing)
                const [locationsResult, optionsResult] = await Promise.all([
                    loadBooleanOptionsLocations(currentPlatform),
                    loadAndParseBooleanOptions()
                ]);
                
                console.log('‚úÖ Loaded options:', parsedBooleanOptions);
                parsedBooleanOptions.loaded = true;
                
                // Render boolean options
                console.log('üé® Rendering boolean options...');
                renderBooleanOptions();
                console.log('‚úÖ Rendering complete');
            }
        }
    }
}

// ============================================================================
// DEV BANNER
// ============================================================================
function updateDevBanner() {
    // Update version from APP_VERSION constant
    const devVersionEl = document.getElementById('devVersion');
    if (devVersionEl) {
        devVersionEl.textContent = APP_VERSION;
    }
    
    // Update build date/time from BUILD_DATE constant
    const devBuildEl = document.getElementById('devBuild');
    if (devBuildEl) {
        const day = String(BUILD_DATE.getDate()).padStart(2, '0');
        const month = String(BUILD_DATE.getMonth() + 1).padStart(2, '0');
        const year = BUILD_DATE.getFullYear();
        const hours = String(BUILD_DATE.getHours()).padStart(2, '0');
        const minutes = String(BUILD_DATE.getMinutes()).padStart(2, '0');
        devBuildEl.textContent = `${day}.${month}.${year} ${hours}:${minutes}`;
    }
    
    // Try to fetch git commit ID from a separate file (if available)
    // This will be generated during deployment
    fetch('GIT_COMMIT.txt')
        .then(response => response.ok ? response.text() : null)
        .then(commitId => {
            const devCommitEl = document.getElementById('devCommit');
            if (devCommitEl && commitId) {
                // Show first 7 characters of commit hash
                devCommitEl.textContent = commitId.trim().substring(0, 7);
            } else if (devCommitEl) {
                devCommitEl.textContent = 'local';
            }
        })
        .catch(() => {
            const devCommitEl = document.getElementById('devCommit');
            if (devCommitEl) {
                devCommitEl.textContent = 'local';
            }
        });
}

// ============================================================================
// URL PARAMETER HANDLING
// ============================================================================
function getLanguageFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const langParam = urlParams.get('lang');
    
    // Validate language parameter
    if (langParam && (langParam === 'de' || langParam === 'en')) {
        return langParam;
    }
    return null;
}

// ============================================================================
// INITIALIZATION
// ============================================================================
async function init() {
    // Update dev banner with version info
    updateDevBanner();
    
    // Determine language: URL parameter > localStorage > default (German)
    const urlLang = getLanguageFromURL();
    const savedLang = localStorage.getItem('sebConfigLang');
    const initialLang = urlLang || savedLang || 'de';
    
    setLanguage(initialLang);
    
    attachEventListeners();
    updatePreview();
}

// Start the application
init();
    </script>
</body>
</html>
